Подпись
=======

**Электронная подпись** — прикрепленный к электронному документу файл, который позволяет определить лицо, подписывающее документ. Является аналогом рукописной подписи в цифровом формате. Электронная подпись формируется закрытым ключом, соответствующим сертификату, и средствами криптографической защиты информации.

Подписи могут быть следующих форматов:

	- Открепленная (отсоединенная) подпись — создается отдельно от подписываемого документа. Файл подписи может иметь расширение .sig,.sgn,.p7s.
	- Прикрепленная (присоединенная) подпись — является частью подписанного документа. К файлу документа добавляется расширение .sig.
	- Встроенная подпись — также является частью документа, но при этом формат исходного документа не меняется. Информацию о подписи содержится в самом документе.

Работа с подписью в Диадоке
---------------------------

С помощью API Диадока нельзя создать подпись для документа, так как для ее создания используется закрытый ключ, который нельзя передавать третьим лицам. Подпись нужно сгенерировать самостоятельно.

Документ для отправки и файл подписи в формате :rfc:`CMS SignedData <5652#section-5>` в `DER <http://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf>`__-кодировке можно передать в следующие методы:

	- метод отправки сообщения :doc:`../http/PostMessage`: передайте подпись в поле ``Signature`` структуры :doc:`../proto/SignedContent`;
	- метод отправки дополнения к сообщению :doc:`../http/PostMessagePatch`: передайте подпись в поле ``Signature`` структуры :doc:`../proto/DocumentSignature`;
	- метод отправки черновика :doc:`../http/SendDraft`: передайте подпись в поле ``Signature`` структуры :doc:`../proto/DocumentSenderSignature`.

В Диадоке существуют подписи под документом следующих видов:

	- подписи отправителя — для отправки документов, сохраненных без отправки,
	- подписи получателя — для двусторонних документов с запросом подписи,
	- согласующие подписи,
	- ответные подписи под запросом на аннулирование документа.

Согласующая подпись
~~~~~~~~~~~~~~~~~~~

В Диадоке есть возможность подписать документ несколькими квалифицированными электронными подписями. Такие подписи называются согласующими.

Согласующие подписи можно ставить как со стороны отправителя, так и со стороны получателя. В день под документом можно поставить не больше 500 согласующих подписей. Диадок проверит и доставит все подписи контрагенту.

Согласующую подпись можно поставить до или после отправки в зависимости от типа документа:

	- для неформализованного документа — до или после отправки. Если поставить согласующую подпись до отправки, то в ящик получателя она доставится только после отправки, вместе с документом и подписью отправителя.
	- для формализованного документа — только после отправки, потому что при отправке формализованного документа меняется его содержимое.

Отправить запрос на подписание документа согласующей подписью можно с помощью метода :doc:`../http/PostMessagePatch`. Для этого заполните поле ``ResolutionRequests`` структуры :doc:`../proto/MessagePatchToPost`.

Передать согласующую подпись можно в поле ``Signature`` структуры :doc:`../proto/DocumentSignature` с флагом ``IsApprovementSignature=true``.

Отличить полученную согласующую подпись от обычной можно по флагу ``IsApprovementSignature`` в структуре :doc:`../proto/Entity`.

Функциональность недоступна по умолчанию. Чтобы получить возможность использовать согласующую подпись, обратитесь к вашему менеджеру или в техническую поддержку.

Представление в API
-------------------
*Структуры для работы с подписями:*
 - :doc:`../proto/SignatureV3` — содержит информацию о подписи под документом.
 - :doc:`../proto/SignatureInfo` — содержит информацию о подписи и сертификате.
 - :doc:`../proto/DocumentSignature` —  предназначена для представления ЭП к некоторым данным в отправляемом сообщении.
 - :doc:`../proto/DocumentSenderSignature` — предназначена для представления ЭП к документам отправляемого черновика.

*Методы для работы с подписями:*
 - :doc:`../http/GetSignatureInfo` — возвращает информацию о подписи и сертификате в сообщении.

