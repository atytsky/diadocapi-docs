Работа с документами 820 формата
================================

.. contents:: :local:
	:depth: 3

Утвержденный `приказом ФНС России от 19.12.2018 №ММВ-7-15/820@ <https://normativ.kontur.ru/document?moduleId=1&documentId=328588>`_ формат распространяется на следующие типы документов:

	- счет-фактуру;
	- первичный документ, подтверждающий совершение хозяйственной операции — накладные, акты и другие первичные документы;
	- универсальный передаточный документ (УПД), который совмещает в себе счет-фактуру и первичный документ, подтверждающий совершение хозяйственной операции.

Форма универсального передаточного документа и рекомендации по его заполнению приведены в письме ФНС России `от 21.10.13 № ММВ-20-3/96@ <https://normativ.kontur.ru/document?moduleId=1&documentId=220334>`__.

.. note::
	Методы и подходы, описанные ниже, можно использовать для работы с УПД, накладными, актами и счетами-фактурами в 820 формате.

Сценарий работы с документами 820 формата включает следующие шаги:

	- Продавец:
		- генерирует титул продавца,
		- отправляет его покупателю.
	- Покупатель:
		- получает титул продавца,
		- при необходимости парсит полученный титул, 
		- генерирует титул покупателя,
		- отправляет его продавцу.


Генерация титула продавца
-------------------------

Для генерации титула продавца используйте метод :doc:`../http/GenerateTitleXml`. Инструкция о генерации приведена на странице :doc:`../instructions/generation`.

Чтобы сгенерировать титул продавца, нужно получить необходимую информацию из метода :doc:`../http/GetDocumentTypes`. Инструкция о получении данных из метода ``GetDocumentTypes`` приведена на странице :doc:`../instructions/getdoctypes`.

Из ответа метода ``GetDocumentTypes`` для УПД в 820 формате возьмем следующие значения:

	- ``documentTypeNamedId = UniversalTransferDocument``,
	- ``documentFunction = СЧФДОП``,
	- ``documentVersion = utd820_05_01_02_hyphen``,
	- ``titleIndex = 0`` (титул продавца).

Кроме этого нужно подготовить содержимое титула — упрощенный XML-файл ``UserDataXml``. Подробнее см. :doc:`../instructions/generation`.

С помощью полученных данных можно сгенерировать титул продавца методом :doc:`../http/GenerateTitleXml`.

**Пример HTTP-запроса:**

.. code-block:: http

	POST /GenerateTitleXml?boxId=a96be310-0982-461a-8b2a-91d198b7861c&documentTypeNamedId=UniversalTransferDocument&documentFunction=СЧФДОП&documentVersion=utd820_05_01_02_hyphen&titleIndex=0 HTTP/1.1
	Host: diadoc-api.kontur.ru
	Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}
	Content-Type: application/xml; charset=utf-8

**Пример тела запроса (UserDataXml):**

.. container:: toggle

 .. code-block:: xml

	<?xml version="1.0" encoding="utf-8"?>
	<UniversalTransferDocumentWithHyphens Function="СЧФДОП"
			DocumentDate="01.08.2019"
			DocumentNumber="140"
			DocumentCreator="1"
			DocumentCreatorBase="1"
			CircumFormatInvoice="4"
			Currency="643" >
		<Sellers>
		<Seller>
			<OrganizationDetails OrgType="2"
					Inn="114500647890"
					FnsParticipantId="2BM-participantId1"
					OrgName="ИП Продавец Иван Иванович">
				<Address>
					<RussianAddress Region="02"/>
				</Address>
			</OrganizationDetails>
		</Seller>
		</Sellers>
		<Buyers>
		<Buyer>
			<OrganizationReference OrgType="1"
				BoxId="53d55d52-9317-4ad4-a7d9-5e9dd3cd6367"/>
		</Buyer>
		</Buyers>
		<Table TotalWithVatExcluded="0" Vat="0" Total="0">
		<Item Product="Товарная позиция"
			Unit="796"
			Quantity="0"
			Price="0"
			TaxRate="без НДС"
			SubtotalWithVatExcluded="0"
			Vat="0"
			Subtotal="0"
			Excise="10"/>
		</Table>
		<TransferInfo OperationInfo="Товары переданы"/>
		<Signers>
		<SignerDetails Inn="123456789047"
			LastName="Подписантов"
			FirstName="Иван"
			MiddleName="Иванович"
			RegistrationCertificate="1"
			SignerPowers="0"
			SignerType="3"
			SignerStatus="1"
			SignerPowersBase="Должностные обязанности"/>
		</Signers>
	</UniversalTransferDocumentWithHyphens>

**Пример тела ответа (титул продавца):**

.. container:: toggle

 .. code-block:: xml

	HTTP/1.1 200 OK

	<?xml version="1.0" encoding="windows-1251"?>
	<Файл ИдФайл="ON_NSCHFDOPPR_2BM-9670670494-967001000-202201240241297341956_2BM-participantId1_20220124_f972e93e-4c69-4c9e-9656-be3a5a072e72" ВерсФорм="5.01" ВерсПрог="Diadoc 1.0">
		<СвУчДокОбор ИдОтпр="2BM-participantId1" ИдПол="2BM-9670670494-967001000-202201240241297341956">
			<СвОЭДОтпр ИННЮЛ="6663003127" ИдЭДО="2BM" НаимОрг="АО &quot;ПФ &quot;СКБ Контур&quot;" />
		</СвУчДокОбор>
		<Документ КНД="1115131" ВремИнфПр="18.17.45" ДатаИнфПр="24.01.2022" НаимЭконСубСост="1" Функция="СЧФДОП" ПоФактХЖ="Документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)" НаимДокОпр="Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)" ОснДоверОргСост="1">
		<СвСчФакт НомерСчФ="140" ДатаСчФ="01.08.2019" КодОКВ="643">
			<СвПрод>
				<ИдСв>
					<СвИП ИННФЛ="114500647890">
						<ФИО Фамилия="Продавец" Имя="Иван" Отчество="Иванович" />
					</СвИП>
				</ИдСв>
				<Адрес>
					<АдрРФ КодРегион="02" />
				</Адрес>
			</СвПрод>
			<СвПокуп>
				<ИдСв>
					<СвЮЛУч НаимОрг="Документация-получатель" ИННЮЛ="9670670494" КПП="967001000" />
				</ИдСв>
				<Адрес>
					<АдрРФ Индекс="777777" КодРегион="50" Город="г. Москва" />
				</Адрес>
			</СвПокуп>
			<ДопСвФХЖ1 НаимОКВ="Российский рубль" ОбстФормСЧФ="4" />
		</СвСчФакт>
		<ТаблСчФакт>
			<СведТов НомСтр="1" НаимТов="Товарная позиция" ОКЕИ_Тов="796" КолТов="0" ЦенаТов="0.00" СтТовБезНДС="0.00" НалСт="без НДС" СтТовУчНал="0.00">
				<Акциз>
					<СумАкциз>
						10.00
					</СумАкциз>
				</Акциз>
				<СумНал>
					<СумНал>
						0.00
					</СумНал>
				</СумНал>
				<ДопСведТов НаимЕдИзм="шт" />
			</СведТов>
			<ВсегоОпл СтТовБезНДСВсего="0.00" СтТовУчНалВсего="0.00">
				<СумНалВсего>
					<СумНал>
						0.00
					</СумНал>
				</СумНалВсего>
			</ВсегоОпл>
		</ТаблСчФакт>
		<СвПродПер>
			<СвПер СодОпер="Товары переданы">
				<ОснПер НаимОсн="Без документа-основания" />
			</СвПер>
		</СвПродПер>
		<Подписант ОснПолн="Должностные обязанности" ОблПолн="0" Статус="1">
			<ФЛ ИННФЛ="123456789047">
				<ФИО Фамилия="Подписантов" Имя="Иван" Отчество="Иванович" />
			</ФЛ>
		</Подписант>
		</Документ>
	</Файл>


Отправка титула продавца
------------------------

Сформированный титул продавца можно подписать и отправить покупателю с помощью метода :doc:`../http/PostMessage`. Инструкция об отправке документа приведена в разделе :ref:`doc_send`.

**Пример тела запроса:**

.. container:: toggle

 .. code-block:: json

	"FromBoxId": "a96be310-0982-461a-8b2a-91d198b7861c",
	"ToBoxId": "13254c42-b4f7-4fd3-3324-0094aeb0f15a",
	"DocumentAttachments": [
		{
			"SignedContent":
			{
				"Content": "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0...NC50Ls+",		// содержимое XML-файла в кодировке base-64
				"Signature": "MIIN5QYJKoZIhvcNAQcCoIIN1jCCDdIA...kA9MJfsplqgW",		// содержимое файла подписи в кодировке base-64
			},
			"TypeNamedId": "UniversalTransferDocument",
			"Function": "СЧФДОП",
			"Version": "utd820_05_01_02_hyphen"
		}
	]

После отправки титула продавца Диадок автоматически формирует подтверждение оператора о дате получения документа, а покупатель формирует извещение о получении титула и отправляет его продавцу. О том, как получить эти служебные документы, написано в инструкциях:

	- :ref:`service_get_InvoiceConfirmation`
	- :ref:`service_get_InvoiceReceipt`


Получение титула продавца в ящике покупателя
--------------------------------------------

Получение через ленту событий
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

О появлении титула продавца в ящике покупателя можно узнать с помощью методов чтения ленты событий: :doc:`../http/GetNewEvents` и :doc:`../http/GetDocflowEvents_V3`.

Отличить формат полученного документа можно по ответам этих методов. В них возвращается версия документа ``Version``: для документов 820 формата версия будет начинаться с ``utd820``, — например, ``utd820_05_01_02_hyphen``.

Из ленты событий можно узнать идентификаторы документа ``MessageId`` и ``DocumentId``, а также запросить дополнительную информацию по документу с помощью методов :doc:`../http/GetMessage`, :doc:`../http/GetDocument`, :doc:`../http/GetDocflows_V3`.

Получение через поиск
~~~~~~~~~~~~~~~~~~~~~

Чтобы найти все входящие документы, которые нужно обработать, используйте метод :doc:`../http/GetDocuments`:

	- в поле ``boxId`` укажите идентификатор ящика, в котором нужно найти входящие документы;
	- в поле ``filterCategory`` укажите статус и тип документа ``UniversalTransferDocument.InboundNotFinished``.

**Пример запроса на поиск УПД:**

.. code-block:: http

	GET /V3/GetDocuments?filterCategory=UniversalTransferDocument.InboundNotFinished&boxId=db32772b-9256-49a8-a133-fda593fda38a HTTP/1.1
	Host: diadoc-api.kontur.ru
	Accept: application/json
	Content-Type: application/json charset=utf-8
	Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}

В теле ответа вернется список документов в виде структуры :doc:`../proto/DocumentList` с вложенной структурой :doc:`../proto/Document`. Отличить УПД формата 820 можно по значению поля ``Version``, которое должно начинаться с префикса ``utd820``.

Найденный документ можно получить с помощью метода :doc:`../http/GetMessage`. В запросе передайте параметры, вернувшиеся в теле ответа метода ``GetDocuments``: ``boxId``, ``messageId``, ``entityId``.

**Пример запроса на получение УПД:**

.. code-block:: http

	GET /V3/GetMessage?messageId=bbcedb0d-ce34-4e0d-b321-3f600c920935&entityId=30cf2c07-7297-4d48-bc6f-ca7a80e2cf95&boxId=db32772b-9256-49a8-a133-fda593fda38a HTTP/1.1
	Host: diadoc-api.kontur.ru
	Accept: application/json
	Content-Type: application/json charset=utf-8
	Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}

После получения титула продавца нужно :ref:`сформировать и отправить извещение о получении <service_send_InvoiceReceipt>`.


Парсинг титула продавца
-----------------------

Получить данные о полученном титуле продавца можно следующими способами:

	- взять данные сразу из структуры полученного титула,
	- выполнить парсинг документа, чтобы работать с упрощенным XML-файлом ``UserDataXml``.

Выполнить парсинг документа можно с помощью метода :doc:`../http/ParseTitleXml`.
Для этого необходимо знать тип документа, функцию, версию и номер титула.
Узнать тип, функцию и версию можно следующими способами:

	- из ответов методов :doc:`../http/GetNewEvents`, :doc:`../http/GetDocflowEvents_V3`,  :doc:`../http/GetDocflows_V3`, :doc:`../http/GetMessage`, :doc:`../http/GetDocument`,
	- с помощью метода детектирования :doc:`../http/DetectDocumentTitles`.

**Пример HTTP-запроса:**

.. code-block:: http

	POST /ParseTitleXml?boxId=13254c42-b4f7-4fd3-3324-0094aeb0f15a&documentTypeNamedId=UniversalTransferDocument&documentFunction=СЧФДОП&documentVersion=utd820_05_01_02_hyphen&titleIndex=0 HTTP/1.1
		Host: diadoc-api.kontur.ru
		Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}
		Content-Type: application/xml; charset=utf-8

В теле запроса нужно передать XML-файл полученного титула.

В ответе метод вернет упрощенный XML-файл ``UserDataXml``, аналогичный тому, который был использован при генерации. Не всегда полученный упрощенный XML-файл ответа метода парсинга будет совпадать с упрощенным XML-файлом запроса метода генерации. Это связано с тем, что при генерации документа Диадок автоматически заполняет данные в титуле. Например, по идентификатору ящика Диадок определяет его реквизиты - ИНН, КПП, наименование и т.д. и добавляет их в XML-файл. Поэтому после парсинга в XML-файле будут указаны ИНН, КПП и наименование организации, а не идентификатор ящика, указанный при генерации.

После получения упрощенного XML-файла пользователь может использовать его в своем интеграционном решении.


Генерация титула покупателя
---------------------------

Титул покупателя генерируется аналогично титулу продавца. 

Для генерации титула покупателя используйте метод :doc:`../http/GenerateTitleXml`. Инструкция о генерации приведена на странице :doc:`../instructions/generation`.

Чтобы сгенерировать титул продавца, нужно получить необходимую информацию из метода :doc:`../http/GetDocumentTypes`. Инструкция о получении данных из метода ``GetDocumentTypes`` приведена на странице :doc:`../instructions/getdoctypes`.

Из ответа метода ``GetDocumentTypes`` для УПД в 820 формате возьмем те же значения, что и для титула продавца, но номер титула будет другой:

	- ``documentTypeNamedId`` = ``UniversalTransferDocument``,
	- ``documentFunction`` = ``СЧФДОП``,
	- ``documentVersion`` = ``utd820_05_01_02_hyphen``,
	- ``titleIndex`` = ``1`` (титул покупателя).

Кроме этого нужно подготовить содержимое титула — упрощенный XML-файл ``UserDataXml``. Подробнее см. :doc:`../instructions/generation`.

С помощью полученных данных можно сгенерировать титул покупателя методом :doc:`../http/GenerateTitleXml`.

**Пример HTTP-запроса:**

.. code-block:: http

	POST /GenerateTitleXml?boxId=13254c42-b4f7-4fd3-3324-0094aeb0f15&documentTypeNamedId=UniversalTransferDocument&documentFunction=СЧФДОП&documentVersion=utd820_05_01_02_hyphen&titleIndex=1&letterId=93bdfb88-7b80-484d-883d-765102ca5af5&documentId=fc3c3811-3368-4e47-95f4-5334b9a42654 HTTP/1.1
	Host: diadoc-api.kontur.ru
	Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}
	Content-Type: application/xml; charset=utf-8

**Пример тела запроса (UserDataXml):**

.. container:: toggle

 .. code-block:: xml

	<?xml version="1.0" encoding="utf-8"?>
	<UniversalTransferDocumentBuyerTitle DocumentCreator="ИП Покупатель Иван Иванович" OperationContent="Принято без претензий" xmlns:xs="http://www.w3.org/2001/XMLSchema">
		<Signers>
			<SignerDetails LastName="Покупатель" 
				FirstName="Иван" 
				MiddleName="Иванович" 
				SignerPowers="1" 
				SignerPowersBase="Должностные обязанности" 
				SignerStatus="5" 
				SignerType="2" 
				Inn="114500647890" />
		</Signers>
	</UniversalTransferDocumentBuyerTitle>

**Пример тела ответа (титул покупателя):**

.. code-block:: xml

	<?xml version="1.0" encoding="windows-1251"?>
	<Файл ИдФайл="ON_NSCHFDOPPOK_2BM-participantId1_2BM-participantid2_f3caa5ab-5033-431f-ba0d-3312ee82b25b" ВерсФорм="5.01" ВерсПрог="Diadoc 1.0">
		<СвУчДокОбор ИдОтпр="2BM-7750370234-4012052808304878702630000000000" ИдПол="2BM-7750370234-4012052808304878702630000000004">
			<СвОЭДОтпр ИННЮЛ="6663003127" ИдЭДО="2BM" НаимОрг="АО &quot;ПФ &quot;СКБ Контур&quot;" />
		</СвУчДокОбор>
		<ИнфПок КНД="1115132" ВремИнфПок="14.50.14" ДатаИнфПок="17.10.2019" НаимЭконСубСост="ИП Покупатель Иван Иванович">
			<ИдИнфПрод ВремФайлИнфПр="14.32.21" ДатаФайлИнфПр="20.05.2019" ИдФайлИнфПр="ON_NSCHFDOPPR_2BM-participantId2_2BM-participantId1_20191011_2ebfc880-6e31-4042-8302-c5201523fc3c">
				<ЭП>MIAGCSqGSIb3DQEHAq...agAAAAAAAA==</ЭП>
			</ИдИнфПрод>
			<СодФХЖ4 ДатаСчФИнфПр="01.02.2003" НаимДокОпрПр="Счет-фактура и документ об отгрузке товаров (выполнении работ), передаче имущественных прав (документ об оказании услуг)" Функция="СЧФДОП" НомСчФИнфПр="140">
				<СвПрин СодОпер="Принято без претензий" />
			</СодФХЖ4>
			<Подписант ОснПолн="Должностные обязанности" ОблПолн="1" Статус="5">
				<ИП ИННФЛ="114500647890">
				<ФИО Фамилия="Покупатель" Имя="Иван" Отчество="Иванович" />
				</ИП>
			</Подписант>
		</ИнфПок>
	</Файл>


Отправка титула покупателя
--------------------------

Сформированный титул покупателя можно подписать и отправить продавцу с помощью метода :doc:`../http/PostMessagePatch`. Инструкция об отправке дополнения приведена в разделе :ref:`doc_patch`.

В результате этих действий получается УПД с двумя подписанными титулами.


XSD-схемы и UserDataXsd
-----------------------

Актуальные XSD-схемы и ``UserDataXml`` можно получить с помощью метода :doc:`../http/GetDocumentTypes`. Инструкция о получении данных из метода ``GetDocumentTypes`` приведена на странице :doc:`../instructions/getdoctypes`.

XSD-схемы для версии титулов версии **utd820_05_01_02_hyphen**:

	- :download:`XSD-схема титула продавца <../xsd/ON_NSCHFDOPPR_1_997_01_05_01_03.xsd>`
	- :download:`XSD-схема титула покупателя <../xsd/ON_NSCHFDOPPOK_1_997_02_05_01_02.xsd>`
	- :download:`XSD-схема упрощенного XML-файла (UserDataXsd) для титула продавца <../xsd/ON_NSCHFDOPPR_UserContract_820_05_01_02_Hyphen.xsd>`
	- :download:`XSD-схема упрощенного XML-файла (UserDataXsd) для титула покупателя <../xsd/ON_NSCHFDOPPOK_UserContract_820_05_01_02.xsd>`


----

.. rubric:: См. также

*Инструкции:*
	- :doc:`../instructions/documents`
	- :doc:`utd970`