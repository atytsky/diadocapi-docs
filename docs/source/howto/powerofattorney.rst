Работа с машиночитаемой доверенностью
=====================================

.. contents:: :local:
	:depth: 3

С 1 марта 2022 года вступают в силу поправки в `Федеральный закон от 06.04.2011 № 63-ФЗ <https://normativ.kontur.ru/document?moduleId=1&documentId=416095>`__. Изменения заключаются в том, что для подписания документов сотрудники компаний могут использовать сертификаты физического лица, в которых указаны только их личные данные без указания принадлежности к организации. Однако только подписи физического лица при обмене документами недостаточно, чтобы вести юридически значимый документооборот организации. Для подтверждения полномочий сотрудника и его принадлежности к компании руководитель должен выпустить машиночитаемую доверенность.

**Машиночитаемая доверенность (МЧД)** — электронный документ в формате XML, используя который руководитель организации передает сотруднику полномочия для подписания документов. С помощью МЧД сотрудники могут ставить подписи от лица организации.
Документ содержит данные о:

- доверителе — организации, которая выдала доверенность,
- доверенном лице — физическом лице, которое уполномочено совершать действие,
- полномочиях сотрудника.

МЧД нужно передавать вместе с каждым документом, который был подписан сертификатом физического лица. Она будет использоваться при подписании документа и таких действиях с документом, как:

- отказ в подписи,
- запрос аннулирования,
- отказ в аннулировании,
- аннулирование,
- запрос уточнения,
- подписание извещения о получении документа.

Чтобы перейти на новый формат подписания документов, сотрудники  и уполномоченные лица организаций должны использовать сертификат физического лица и прикладывать к нему МЧД.

.. note::

	На время переходного периода, пока МЧД не является обязательным требованием, использовать МЧД с сертификатом физического лица не обязательно.
 
Процесс работы с МЧД в Диадоке представлен следующими этапами:

.. contents:: :local:
	:depth: 1


Управление доверенностями
-------------------------

Чтобы сотрудник мог использовать МЧД при работе с документами, ее нужно зарегистрировать и привязать к сотруднику в Диадоке. Это может сделать администратор ящика организации или сам сотрудник. Для этого нужно:

- выпустить доверенность в сервисе Контур.Доверенность по `инструкции <https://support.kontur.ru/pages/viewpage.action?pageId=83873849>`__: Диадок не выпускает МЧД;
- получить информацию о МЧД для ее добавления в Диадок: *XML-файл МЧД + ЭП руководителя* или *регистрационный номер МЧД + ИНН доверителя*;
- :ref:`зарегистрировать МЧД в Диадоке <powerofattorney_register>`;
- :ref:`привязать МЧД к сотруднику <powerofattorney_employee>`;
- :ref:`установить МЧД по умолчанию <powerofattorney_employee>`, чтобы не выбирать ее при каждом действии с документами (необязательно).

Кроме этого Диадок позволяет :ref:`управлять <powerofattorney_employee>` уже привязанными к сотруднику доверенностями:

- получить список МЧД, привязанных к сотруднику,
- отвязать МЧД от сотрудника,
- изменить для МЧД настройку «по умолчанию».


.. _powerofattorney_register:

Регистрация МЧД
~~~~~~~~~~~~~~~

Если у вас есть МЧД и вы хотите использовать ее для работы в Диадоке, ее нужно зарегистрировать. Сделать это можно двумя способами:

- используя регистрационный номер МЧД и ИНН доверителя,
- используя XML-файл МЧД с электронной подписью руководителя.

Для регистрации МЧД вызовите метод :doc:`../http/RegisterPowerOfAttorney`, который вернет идентификатор задачи ``taskId``. По этому идентификатору с помощью метода :doc:`../http/RegisterPowerOfAttorneyResult` можно узнать результат регистрации.

Зарегистрированную МЧД нужно привязать к сотруднику, чтобы использовать ее для выполнения операций в Диадоке.


.. _powerofattorney_employee:

Работа с МЧД сотрудника
~~~~~~~~~~~~~~~~~~~~~~~

Чтобы сотрудник мог использовать МЧД, она должна быть привязана к этому сотруднику. К каждому сотруднику можно привязать до 100 действующих или не вступивших в силу МЧД. Любую из них можно использовать как доверенность по умолчанию. Пользователь в любой момент может сделать другую МЧД доверенностью по умолчанию или убрать доверенность по умолчанию совсем. Любую МЧД, уже привязанную к сотруднику, можно отвязать.

Работать с МЧД сотрудника можно с помощью методов:

- :doc:`../http/AddEmployeePowerOfAttorney` привязывает МЧД к сотруднику;
- :doc:`../http/DeleteEmployeePowerOfAttorney` отвязывает МЧД от сотрудника;
- :doc:`../http/UpdateEmployeePowerOfAttorney` устанавливает сотруднику доверенность по умолчанию или снимает с доверенности такой признак;
- :doc:`../http/GetEmployeePowersOfAttorney` возвращает список всех МЧД, привязанных к сотруднику.


Формирование документа
----------------------

При формировании формализованного документа нужно учесть данные об организации в блоке ``Подписант``. Для этого вместе с сертификатом физического лица укажите МЧД:

- при генерации :ref:`титула с МЧД <generate_title_xml_poa>` методом :doc:`../http/GenerateTitleXml`. Метод заполняет поля блока ``Подписант`` данными, полученными из МЧД.
- при подготовке документа к подписанию методом :doc:`../http/PrepareDocumentsToSign`: для этого в поле ``SignerContent`` структуры :doc:`../proto/PrepareDocumentsToSignRequest` передайте XML-файл универсального подписанта с данными МЧД.

Предварительная проверка МЧД
----------------------------

Перед отправкой документа можно проверить МЧД:

- соответствует ли МЧД установленному формату,
- является ли МЧД действующей (без учета отзыва),
- верна ли подпись, которой подписана МЧД,
- соответствует ли МЧД сертификату, которым будет подписан документ,
- отозвана ли МЧД — проверяется в тех случаях, когда за отведенное время удастся получить информацию о статусе МЧД от сервиса ФНС.

Для предварительной проверки МЧД используйте метод :doc:`../http/PrevalidatePowerOfAttorney`.

.. _powerofattorney_send:

Отправка документа
------------------

Отправить документ с МЧД можно с помощью методов :doc:`../http/PostMessage`, :doc:`../http/SendDraft` и :doc:`../http/PostMessagePatch`. Эти методы принимают на вход структуры :doc:`../proto/SignedContent` и :doc:`../proto/DocumentSenderSignature`, которые хранят информацию о МЧД внутри структуры :doc:`../proto/PowerOfAttorneyToPost`.

Передать МЧД можно способами, описанными в таблице ниже. Для каждого способа существуют свои правила заполнения структуры ``PowerOfAttorneyToPost`` и условия их применения.

.. table:: Способы передачи МЧД

	+------------------------------------+--------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
	| Способ передачи                    | Как указать МЧД                                                          | Условия                                                                                               |
	+====================================+==========================================================================+=======================================================================================================+
	| Файлом в составе пакета документов | Заполнить структуру *Contents*  файлом МЧД и подписью                    | Наличие файла и подписи у интегратора                                                                 |
	|                                    +--------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
	|                                    | Выбрать *UseDefault* или заполнить *FullId* с одновременным *SendAsFile* | Наличие у сотрудника доверенности по умолчанию или указанной доверенности                             |
	+------------------------------------+--------------------------------------------------------------------------+                                                                                                       |
	| Метаданными                        | Выбрать *UseDefault* или заполнить *FullId*                              |                                                                                                       |
	+------------------------------------+--------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+
	| В содержимом документа             | Выбрать *UseDocumentContent*                                             | Заполненный блок про МЧД в XML-файле титула, сформированного методом :doc:`../http/GenerateTitleXml`. |
	|                                    |                                                                          | Применимо только для акта сверки 405 формата и акта о приемке выполненных работ КС-2 691 формата      |
	+------------------------------------+--------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------+

Получение документа
-------------------
 
Получение МЧД в сообщении
~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в сообщении, используйте методы:

- :doc:`../http/GetMessage`,
- :doc:`../http/GetNewEvents`,
- :doc:`../http/GetLastEvent`,
- :doc:`../http/GetEvent`.

Они возвращают информацию о МЧД и ее статусе внутри структуры :doc:`../proto/PowerOfAttorneyInfo`.

Получение МЧД в docflow
~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в docflow, используйте методы:

- :doc:`V3/GetDocflowEvents <../http/GetDocflowEvents_V3>`,
- :doc:`V3/GetDocflows <../http/GetDocflows_V3>`,
- :doc:`V3/GetDocflowsByPacketId <../http/GetDocflowsByPacketId_V3>`,
- :doc:`V3/SearchDocflows <../http/SearchDocflows_V3>`.

Они возвращают:

- информацию об общем (сводном) статусе по всем МЧД для всех сущностей документа внутри структуры :doc:`../proto/PowerOfAttorneyValidationStatus`, хранящейся в :doc:`../proto/DocflowStatusV3`,
- информацию о МЧД и ее статусе из подписи под документом внутри структуры :doc:`../proto/SignaturePowerOfAttorney`, хранящейся в :doc:`../proto/SignatureV3`.

Получение МЧД в документах
~~~~~~~~~~~~~~~~~~~~~~~~~~

Чтобы получить информацию о МЧД в документах, используйте методы

- :doc:`../http/GetDocument`,
- :doc:`../http/GetDocuments`,
- :doc:`../http/GetDocumentsByMessageId`.

Они возвращают информацию об общем (сводном) статусе по всем МЧД для всех сущностей документа внутри структуры :doc:`../proto/PowerOfAttorneyValidationStatus`, хранящейся в :doc:`../proto/DocflowStatusV3`.

Чтобы получить подробную информацию о МЧД, отправленной с документом, используйте метод :doc:`../http/GetPowerOfAttorneyInfo`.


Ответное действие по документу
------------------------------

Для ответного действия по документу вызовите метод :doc:`../http/PostMessagePatch`. Укажите в теле запроса регистрационный номер МЧД и ИНН доверителя или признак «использовать МЧД по умолчанию». Этот метод принимает на вход структуру :doc:`../proto/DocumentSignature`, которая хранят информацию о МЧД внутри структуры :doc:`../proto/PowerOfAttorneyToPost`.

----

.. rubric:: Смотри также

*Методы для работы с МЧД:*
	- :doc:`../http/RegisterPowerOfAttorney` — отправляет запрос на регистрацию МЧД.
	- :doc:`../http/RegisterPowerOfAttorneyResult` — возвращает результат регистрации МЧД.
	- :doc:`../http/GetEmployeePowersOfAttorney` — возвращает МЧД, привязанные к сотруднику.
	- :doc:`../http/AddEmployeePowerOfAttorney` — привязывает МЧД к сотруднику.
	- :doc:`../http/DeleteEmployeePowerOfAttorney` — отвязывает МЧД от сотрудника.
	- :doc:`../http/UpdateEmployeePowerOfAttorney` — изменяет параметр МЧД «Использовать по умолчанию».
	- :doc:`../http/PrevalidatePowerOfAttorney` — выполняет предварительную проверку МЧД.
	- :doc:`../http/GetPowerOfAttorneyInfo` — возвращает информацию о МЧД, отправленной с документом.
	
*Структуры для работы с МЧД:*
	- :doc:`../proto/PowerOfAttorneyToRegister` — хранит данные для регистрации МЧД.
	- :doc:`../proto/PowerOfAttorneyRegisterResult` — хранит данные о результате регистрации МЧД.
	- :doc:`../proto/EmployeePowerOfAttorney` — для хранения информации о МЧД, привязанной к сотруднику.
	- :doc:`../proto/PowerOfAttorneyToUpdate` — для обновления настроек МЧД для сотрудника.
	- :doc:`../proto/PowerOfAttorney` — для хранения информации о МЧД.
	- :doc:`../proto/PowerOfAttorneyFullId` — для хранения идентификатора МЧД.
	- :doc:`../proto/PowerOfAttorneyInfo` — для хранения информации о МЧД и статусе ее проверки.
	- :doc:`../proto/PowerOfAttorneyPrevalidateRequest` — хранит данные для предварительной проверки МЧД.
	- :doc:`../proto/PowerOfAttorneyValidationStatus` — для хранения информации о статусе проверки МЧД.
	- :doc:`../proto/PowerOfAttorneyToPost` — для заполнения данных о МЧД при отправке документов.
	- :doc:`../proto/SignaturePowerOfAttorney` — для хранения информации о МЧД, использованной при подписании документа, и статусе ее проверки.