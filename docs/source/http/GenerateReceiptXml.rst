GenerateReceiptXml
==================

Метод ``GenerateReceiptXml`` генерирует извещения о получении (далее — ИоП) на различные сущности в системе.

Версии метода:

	- :ref:`GenerateReceiptXml V2 <GenerateReceiptXml_v2>`.
	- :ref:`GenerateReceiptXml <GenerateReceiptXml_v1>` — устаревшая версия. Не поддерживает заполнение всех полей извещения о получении формата, утвержденного приказом `№ ЕД-7-26/133@ <https://www.nalog.gov.ru/rn77/about_fts/docs/13194601/>`__.

.. _GenerateReceiptXml_v2:

GenerateReceiptXml V2
---------------------

.. http:post:: /V2/GenerateReceiptXml

	:queryparam boxId: идентификатор :doc:`ящика <../entities/box>` организации.

	:requestheader Authorization: данные, необходимые для :doc:`авторизации <../Authorization>`.

	:request Body: Тело запроса должно содержать структуру :doc:`../proto/ReceiptGenerationRequestV2`.
	
	:statuscode 200: операция успешно завершена.
	:statuscode 400: данные в запросе имеют неверный формат или отсутствуют обязательные параметры.
	:statuscode 401: в запросе отсутствует HTTP-заголовок ``Authorization`` или в этом заголовке содержатся некорректные авторизационные данные.
	:statuscode 402: у организации с указанным идентификатором ``boxId`` закончилась подписка на API.
	:statuscode 403: доступ к ящику с предоставленным авторизационным токеном запрещен.
	:statuscode 405: используется неподходящий HTTP-метод.
	:statuscode 409: формирование ИоПа для данной сущности невозможно.
	:statuscode 500: при обработке запроса возникла непредвиденная ошибка.

	:responseheader Content-Disposition: имя файла с извещением.
	
	:response Body: Тело ответа содержит XML-файл ИоПа для сущности ``attachmentId`` из сообщения ``messageId`` в ящике ``boxId``. Файл с извещением формируется в соответствии с :download:`XSD-схемой <../xsd/DP_IZVPOL_1_982_00_01_03_01.xsd>`. В Диадоке можно отправлять ИоПы на следующие сущности:

.. csv-table::
    :header: "Тип ИоПа", "AttachmentType соответствующей сущности", "Кто шлет ИоП", "Кто получает ИоП"
    :widths: 10, 10, 10, 10

    "На титул отправителя", "Title или старый точечный титул отправителя", "Получатель документа", "Отправитель документа"
    "На титул получателя", "Title или старый точечный титул получателя", "Отправитель", "Получатель"
	"На уведомление об уточнении", "InvoiceCorrectionRequest", "Отправитель", "Получатель"

Для каждого типа документа возможность отправки ИоП задается в свойствах :doc:`вида документооборота <../proto/DocumentWorkflow>` документа: свойства «ИоП на титул участника» для отправителя и получателя (``TitleReceiptBehavior``), «Ответное действие на УоУ» (``AmendmentRequestResponseBehavior``).

После успешной генерации файл можно загрузить в систему, передав в методе :doc:`../http/PostMessagePatch` в структуре ``Receipts``.

.. _GenerateReceiptXml_v1:

GenerateReceiptXml
------------------

.. warning::
	Методы ``GenerateDocumentReceiptXml`` и ``GenerateInvoiceDocumentReceiptXml`` расширены и поддерживают весь функционал нового метода, но считаются устаревшими и не рекомендуются к использованию.

.. http:post:: /GenerateReceiptXml

	:queryparam boxId: идентификатор :doc:`ящика <../entities/box>` организации.
	:queryparam messageId: идентификатор сообщения.
	:queryparam attachmentId: идентификатор :doc:`сущности <../proto/Entity message>`, для которой требуется сформировать ИоП.

	:requestheader Authorization: данные, необходимые для :doc:`авторизации <../Authorization>`.

	:request Body: Тело запроса должно содержать данные о подписанте генерируемого извещения в виде сериализованной структуры :doc:`../proto/Signer`.
	
	:statuscode 200: операция успешно завершена.
	:statuscode 400: данные в запросе имеют неверный формат или отсутствуют обязательные параметры.
	:statuscode 401: в запросе отсутствует HTTP-заголовок ``Authorization`` или в этом заголовке содержатся некорректные авторизационные данные.
	:statuscode 402: у организации с указанным идентификатором ``boxId`` закончилась подписка на API.
	:statuscode 403: доступ к ящику с предоставленным авторизационным токеном запрещен.
	:statuscode 405: используется неподходящий HTTP-метод.
	:statuscode 409: формирование ИоПа для данной сущности невозможно.
	:statuscode 500: при обработке запроса возникла непредвиденная ошибка.

	:responseheader Content-Disposition: имя файла с извещением.
	
	:response Body: Тело ответа содержит XML-файл ИоПа для сущности ``attachmentId`` из сообщения ``messageId`` в ящике ``boxId``. На текущий момент в Диадоке можно отправлять ИоПы на следующие сущности:

.. csv-table::
    :header: "Тип ИоПа", "AttachmentType соответствующей сущности", "Кто шлет ИоП", "Кто получает ИоП"
    :widths: 10, 10, 10, 10

    "На титул отправителя", "Title (или старый точечный титул отправителя)", "Получатель документа", "Отправитель документа"
    "На титул получателя", "Title (или старый точечный титул получателя)", "Отправитель", "Получатель"
	"На уведомление об уточнении", "InvoiceCorrectionRequest", "Отправитель", "Получатель"

Для каждого типа документа возможность отправки ИоП задается в свойствах вида документооборота :doc:`../proto/DocumentWorkflow` документа: свойства «ИоП на титул участника» для отправителя и получателя (``TitleReceiptBehavior``), «Ответное действие на УоУ» (``AmendmentRequestResponseBehavior``).

Файл с извещением формируется в соответствии с `XML-схемой <https://diadoc.kontur.ru/sdk/xsd/DP_IZVPOL_1_982_00_01_01_02.xsd>`__.

После успешной генерации файла его можно загрузить в систему, передав в методе :doc:`../http/PostMessagePatch` в структуре ``Receipts``.

.. warning::
	Методы ``GenerateDocumentReceiptXml`` и ``GenerateInvoiceDocumentReceiptXml`` расширены и поддерживают весь функционал нового метода, но считаются устаревшими и не рекомендуются к использованию.