Работа с документами
====================

.. contents:: :local:

Работать с документами можно только внутри :doc:`сообщения <entities/message>`.

.. _doc_send:

Отправка сообщения
------------------

Подготовка и отправка исходящих сообщений осуществляется с помощью метода :doc:`http/PostMessage`.
В метод нужно передать структуру :doc:`proto/MessageToPost`: она должна содержать идентификаторы :doc:`ящиков <entities/box>` участников документооборота, набор отправляемых документов и настройки.
В качестве ящика отправителя пользователь может указать только ящик, к которому он имеет доступ с текущим авторизационным токеном.

После вызова метода ``PostMessage`` в ящике отправителя формируется:

- цепочка документооборота и информация о связанных с ней документах,
- событие о появлении сообщения.

В ящике получателя эта информация появится с некоторой задержкой: это связано с асинхронной передачей информации из ящика отправителя в ящик получателя.
То есть успешный вызов метода ``PostMessage`` гарантирует лишь появление исходящего сообщения в ящике отправителя; в ящике получателя сообщение и соответствующее событие могут появиться с задержкой.

Не отправляйте формализованные документы размером более 3 Мб. Это может увеличить время обработки документа и завершиться ошибкой.

Если размер отправляемого документа больше 500 Кб, рекомендуем использовать :doc:`полку документов <entities/shelf>`.

.. _doc_draft:

Создание черновика
~~~~~~~~~~~~~~~~~~

Метод :doc:`http/PostMessage` можно использовать для создания :doc:`черновиков <entities/draft>` — сообщений, содержащих документы без подписей к ним.

Чтобы создать черновик, укажите флаг ``IsDraft`` в структуре :doc:`proto/MessageToPost` при создании сообщения. Такое сообщение будет загружено на сервер, но задание на отправку сообщения получателю формироваться не будет.

Для формирования подписей к документам и отправки сообщения на основе черновика используйте метод :doc:`http/SendDraft`.

.. _doc_delaysend:

Отложенная отправка
~~~~~~~~~~~~~~~~~~~

Когда нужно сохранить исходящий документ без отправки, чтобы подписать и отправить его позже, используйте **отложенную отправку**.
Это может быть полезно, если:

	- документы перед отправкой нужно согласовать с другими сотрудниками;
	- документ перед отправкой нужно дополнить данными, как в случае с :doc:`маркированными товарами <howto/marking_ttgis>`;
	- когда документ был создан с помощью интеграционного решения, а подпись и отправка будет осуществляться из веб-сервиса.

Чтобы сохранить документ без отправки, используйте функцию **отложенной отправки**.
Для этого в структуре :doc:`proto/MessageToPost` установите флаг ``DelaySend``. При вызове метода :doc:`http/PostMessage` документ с этим флагом будет сохранен в разделе исходящих документов. Такой документ называется **исходящим неотправленным документом**.

Если перед отправкой нужно отредактировать документ, используйте :ref:`настройки редактирования <editing_settings>`. Для этого в поле ``MessageToPost.DocumentAttachment.EditingSettingId`` укажите значение идентификатора настройки редактирования, полученного у вашего менеджера.

Чтобы согласовать исходящий неотправленный документ, используйте метод :doc:`http/PostMessagePatch`. Если никаких действий с документом больше не требуется, его можно подписать и отправить с помощью метода :doc:`http/PostMessagePatch`.
	
Исходящий неотправленный документ можно найти с помощью метода :doc:`http/GetDocuments`. Для этого в запросе используйте фильтр ``DocumentStatus = WaitingForSenderSignature``.

Отличия исходящего неотправленного документа от других сущностей приведено в :ref:`таблице <template_draft_delaysend>`.

У исходящего неотправленного документ есть ограничения:

- под таким документом не может быть подписи или запроса на подпись по доверенности,
- нельзя изменить содержимое документа и реквизиты получателя, за исключением документов с :ref:`настройками редактирования <editing_settings>`.


.. _template_draft_delaysend:

Шаблон, черновик или неотправленный документ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Используйте :doc:`шаблон <entities/template>`, :doc:`черновик <entities/draft>` или :ref:`исходящий неотправленный документ <doc_delaysend>` в подходящих для этого сценариях. Ниже в таблице приведены различия этих сущностей.

.. table:: Различия черновика, шаблона и исходящего неотправленного документа

	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	|                                 | Шаблон                                              | Черновик                              | Исходящий неотправленный документ                  |
	+=================================+=====================================================+=======================================+====================================================+
	| Свойства                        | Сообщение без подписей. На его основе можно создать | «Заготовка» документа, т.е. сущность, | Уже готовый к отправке документ, сохраненный в     |
	|                                 | один или несколько документов — в зависимости от    | на основе которой можно создать один  | разделе «Исходящие».                               |
	|                                 | настроек.                                           | документ.                             | Имеет статус «Требуется подписать и отправить».    |
	|                                 | С шаблоном можно работать в своем ящике или         |                                       |                                                    |
	|                                 | отправить контрагенту.                              |                                       |                                                    |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Где хранится                    | в ящике отправителя или получателя                  | в ящике отправителя                   | в ящике отправителя                                |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Можно ли редактировать перед    | да, если указаны                                    | нет                                   | да, если указаны                                   |
	| отправкой                       | :ref:`настройки редактирования <editing_settings>`  |                                       | :ref:`настройки редактирования <editing_settings>` |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Что будет после отправки        | в зависимости от настроек:                          | черновик будет удален                 | будет отправлен контрагенту                        |
	|                                 |                                                     |                                       |                                                    |
	|                                 | - если шаблон одноразовый, то он будет удален       |                                       |                                                    |
	|                                 |   после создания документа;                         |                                       |                                                    |
	|                                 | - если шаблон многоразовый, то он продолжит         |                                       |                                                    |
	|                                 |   существовать после создания документа.            |                                       |                                                    |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+


Дополнение сообщения
--------------------

Сформированные сообщения можно дополнять служебными документами с помощью метода :doc:`http/PostMessagePatch`, в который передается структура :doc:`proto/MessagePatchToPost`. Эта структура должна содержать идентификатор :doc:`ящика <entities/box>`, хранящего сообщение, и идентификатор цепочки документооборота, которую нужно дополнить новым документом.
Пользователь, вызывающий метод, должен иметь доступ к ящику, в котором хранится сообщение.

В результате работы метода сообщение будет обновлено в ящиках всех участников документооборота. В ящике получателя обновление может произойти с задержкой.

Получение сообщения
-------------------

Чтобы получить информацию о текущем состоянии сообщения и о документах, составляющих цепочку документооборота, используйте метод :doc:`http/GetMessage`. Он возвращает структуру :doc:`proto/Message`.

Структура :doc:`proto/Message` может содержать документы, сформированные в разное время разными организациями: например, в одну структуру могут попасть исходящий документ одной организации и подпись к нему, поставленная представителем другой организации.

Чтобы получить содержимое конкретного документа из сообщения, используйте метод :doc:`http/GetEntityContent`. В него нужно передать идентификаторы ящика, сообщения и :doc:`сущности <entities/entity>`, т.е. значения полей ``boxId`` и ``messageId`` структуры :doc:`proto/Message` и поля ``entityId`` структуры :doc:`Entity <proto/Entity message>`.

События
-------

Состояние каждого :doc:`ящика <entities/box>` в Диадоке может изменяться только в следующих случаях:

- в ящике формируется новая цепочка документооборота, т.е. появляется новое сообщение;
- дополняется уже существующая в ящике цепочка документооборота, т.е. дополняется существующее сообщение.

Уже хранящаяся в ящике информация не может быть изменена: она может быть только дополнена. Все модификации ящика упорядочиваются хронологически.
Эти модификации в Диадоке называются **событиями**.

События соответствуют изменениям, произошедшим в ящике, и бывают двух видов:

- событие о формировании новой цепочки документооборота;
- событие о добавлении документа к уже существующей цепочки документооборота.

Чтобы получить информацию о новых событиях, используйте метод :doc:`http/GetNewEvents`. Этот метод возвращает упорядоченный хронологически поток всех событий :doc:`proto/BoxEvent`, произошедших в указанном ящике.

Получение документов
--------------------

Получить документы можно с помощью следующих методов:

- :doc:`http/GetDocuments` — позволяет получить список документов, удовлетворяющих заданным фильтрам. Например, можно запросить список всех входящих счетов-фактур от указанного контрагента за определенный период. В некоторых случаях использование этого метода может оказаться удобнее, чем получение новостей методами :doc:`http/GetNewEvents`, :doc:`http/GetEvent` и :doc:`http/GetMessage`.
- :doc:`http/GetDocument` — позволяет получить всю информацию о документе по его идентификатору.