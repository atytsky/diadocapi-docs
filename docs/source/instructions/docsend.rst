Отправка документов
===================

.. contents:: :local:

Работать с документами можно только внутри :doc:`сообщения <../entities/message>`.


.. _doc_prepare_to_sign:

Подготовка документа к подписанию
---------------------------------

Метод :doc:`../http/PrepareDocumentsToSign` позволяет автоматически добавить в XML-файл информацию о подписанте. К подписанию можно подготовить :doc:`черновик<../entities/draft>`, незагруженный в Диадок формализованный документ или :ref:`неотправленный исходящий документ<doc_delaysend>`. Дополнить можно только первый титул документа, второй титул генерируется сразу со всеми данными. 

Кроме данных подписанта в файл можно добавить:

	- версию формата и программы,
	- дату и время формирования файлов,
	- идентификатор файла.

Данные подписанта, в зависимости от его типа, можно указать в структурах :doc:`../proto/Signer` или :doc:`../proto/ExtendedSigner` или в поле ``SignerContent``. Чтобы определить тип подписанта, используйте метод :doc:`../http/GetDocumentTypes`, тип подписанта вернется в поле ``SignerType`` структуры :doc:`SignerInfoV2 <../proto/DocumentTypeDescriptionV2>`.

В зависимости от типа подписанта заполните его следующим образом:

	- простой подписант — при вызове метода ``PrepareDocumentsToSign`` заполните структуру ``Signer``.
	- расширенный подписант — при вызове метода ``PrepareDocumentsToSign`` заполните структуру ``ExtendedSigner``.
	- универсальный подписант — передайте бинарное представление упрощенного XML-файла подписанта в поле ``SignerContent``. Чтобы подготовить упрощенный XML-файл подписанта, выполните следующие действия: 

		1. С помощью метода ``GetDocumentTypes`` получите URL-путь метода, возвращающего файл XSD-схемы упрощенного XML подписанта. URL-путь возвращается в поле ``SignerUserDataXsdUrl``.
		2. С помощью URL-пути вызовите метод :doc:`../http/GetContent`. В ответ метод вернет файл XSD-схемы SignerUserData.xsd.
		3. По полученной схеме подготовьте упрощенный XML-файл подписанта одним из следующих способов:
		
			- используйте кодогенерацию в SDK;
			- вручную укажите все данные для блока Подписант в упрощенном XML-файле;
			- укажите в файле данные, по которым Диадок сможет дополнить информацию, например, идентификатор ящика организации, отпечаток сертификата, регистрационный номер МЧД и ИНН доверителя. Диадок по переданным данным заполнит блок Подписант.

В ответе метод ``PrepareDocumentsToSign`` возвращает список документов, подготовленных к подписанию и отправке.

.. _doc_send:

Отправка сообщения
------------------

Подписать и отправить исходящие сообщения можно с помощью метода :doc:`../http/PostMessage`.

Обратите внимание, что API Диадока не создает :doc:`файл подписи <../entities/signature>`, его нужно сгенерировать самостоятельно.

В теле запроса метода нужно передать структуру :doc:`../proto/MessageToPost`. Структура должна содержать идентификаторы ящиков участников документооборота и набор отправляемых документов:

	- ``FromBoxId`` — идентификатор ящика отправителя. Можно указать только тот ящик, к которому у пользователя есть доступ с текущим авторизационным токеном.
	- ``ToBoxId`` — идентификатор ящика получателя.
	- ``DocumentAttachment`` — вложенная структура для передачи XML-файла документа:

		- ``SignedContent.Content`` — XML-файл документа,
		- ``SignedContent.Signature`` — файл подписи,
		- ``TypeNamedId`` — тип документа,
		- ``Function`` — функция документа,
		- ``Version`` — версия документа,
		- ``SignedContent.PowerOfAttorneyToPost`` — машиночитаемая доверенность (МЧД). Указать ее можно следующими способами:

			- указать регистрационный номер МЧД в формате GUID и ИНН доверителя во вложенной структуре ``PowerOfAttorneyToPost.PowerOfAttorneyFullId`` в полях ``RegistrationNumber`` и ``IssuerInn`` соответственно,
			- использовать флаг ``PowerOfAttorneyToPost.UseDefault = true``, если у пользователя установлена МЧД по умолчанию;
			- передать файл доверенности и подпись к ней во вложенной структуре ``PowerOfAttorneyToPost.Contents``; файл передается в поле ``Content``, подпись — в поле ``Signature``.

**Пример заполнения структуры MessageToPost:**

.. container:: toggle

 .. code-block:: json

   "FromBoxId": "db32772b-9256-49a8-a133-fda593fda38a",
   "ToBoxId": "13254c42-b4f7-4fd3-3324-0094aeb0f15a",
   "DocumentAttachments": [
         {
            "SignedContent":
            {
               "Content": "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0...NC50Ls+",      //контент xml-файла в кодировке base-64
               "Signature": "MIIN5QYJKoZIhvcNAQcCoIIN1jCCDdIA...kA9MJfsplqgW",      //контент файла подписи в кодировке base-64
               {
                  "PowerOfAttorney":
                     "FullId":
                     {
                        "RegistrationNumber": "регистрационный номер МЧД",
                        "IssuerInn": "ИНН доверителя"
                     },
               },
            },
            "TypeNamedId": "тип документа",
            "Function": "функция документа",
            "Version": "версия документа"
         }
      ]
   }

После вызова метода :doc:`../http/PostMessage` в ящике отправителя формируется:

	- цепочка документооборота и информация о связанных с ней документах,
	- событие о появлении сообщения.

В ящике получателя эта информация появится с некоторой задержкой: это связано с асинхронной передачей информации из ящика отправителя в ящик получателя. То есть успешный вызов метода :doc:`../http/PostMessage` гарантирует лишь появление исходящего сообщения в ящике отправителя.

Не отправляйте формализованные документы размером более 3 Мб. Это может увеличить время обработки документа и завершиться ошибкой.

Если размер отправляемого документа больше 500 Кб, рекомендуем использовать :doc:`полку документов <../entities/shelf>`.

.. _doc_delaysend:

Отложенная отправка
-------------------

Когда нужно сохранить исходящий документ без отправки, чтобы подписать и отправить его позже, используйте **отложенную отправку**.
Это может быть полезно, если:

	- документы перед отправкой нужно согласовать с другими сотрудниками;
	- документ перед отправкой нужно дополнить данными, как в случае с :doc:`маркированными товарами <../howto/marking_ttgis>`;
	- когда документ был создан с помощью интеграционного решения, а подпись и отправка будет осуществляться из веб-сервиса.

Чтобы сохранить документ без отправки, используйте функцию **отложенной отправки**.
Для этого в структуре :doc:`../proto/MessageToPost` установите флаг ``DelaySend``. При вызове метода :doc:`../http/PostMessage` документ с этим флагом будет сохранен в разделе исходящих документов. Такой документ называется **исходящим неотправленным документом**.

Если перед отправкой нужно отредактировать документ, используйте :ref:`настройки редактирования <editing_settings>`. Для этого в поле ``MessageToPost.DocumentAttachment.EditingSettingId`` укажите значение идентификатора настройки редактирования, полученного у вашего менеджера.

Чтобы согласовать исходящий неотправленный документ, используйте метод :doc:`../http/PostMessagePatch`. Исходящий неотправленный документ можно подписать несколькими :ref:`согласующими подписями <resolution_signature>`.

Если никаких действий с документом больше не требуется, его можно подписать и отправить с помощью метода :doc:`../http/PostMessagePatch`. Подписание неотправленного документа :doc:`основной подписью <../entities/signature>` равносильно его отправке.
	
Исходящий неотправленный документ можно найти с помощью метода :doc:`../http/GetDocuments`. Для этого в запросе используйте фильтр ``DocumentStatus = WaitingForSenderSignature``.

У исходящего неотправленного документ есть ограничения:

- под таким документом не может быть подписи или запроса на подпись по доверенности,
- нельзя изменить содержимое документа и реквизиты получателя, за исключением документов с :ref:`настройками редактирования <editing_settings>`.

Отличия исходящего неотправленного документа от других сущностей приведено в :ref:`таблице <template_draft_delaysend>`.

.. _doc_draft:

Создание черновика
------------------

Метод :doc:`../http/PostMessage` можно использовать для создания :doc:`черновиков <../entities/draft>` — сообщений, содержащих документы без подписей к ним.

Чтобы создать черновик, укажите флаг ``IsDraft`` в структуре :doc:`../proto/MessageToPost` при создании сообщения. Такое сообщение будет загружено на сервер, но задание на отправку сообщения получателю формироваться не будет.

Для формирования подписей к документам и отправки сообщения на основе черновика используйте метод :doc:`../http/SendDraft`.

.. _template_draft_delaysend:

Шаблон, черновик или неотправленный документ
--------------------------------------------

Используйте :doc:`шаблон <../entities/template>`, :doc:`черновик <../entities/draft>` или :ref:`исходящий неотправленный документ <doc_delaysend>` в подходящих для этого сценариях. Ниже в таблице приведены различия этих сущностей.

.. table:: Различия черновика, шаблона и исходящего неотправленного документа

	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	|                                 | Шаблон                                              | Черновик                              | Исходящий неотправленный документ                  |
	+=================================+=====================================================+=======================================+====================================================+
	| Свойства                        | Сообщение без подписей. На его основе можно создать | «Заготовка» документа, т.е. сущность, | Уже готовый к отправке документ, сохраненный в     |
	|                                 | один или несколько документов — в зависимости от    | на основе которой можно создать один  | разделе «Исходящие».                               |
	|                                 | настроек.                                           | документ.                             | Имеет статус «Требуется подписать и отправить».    |
	|                                 | С шаблоном можно работать в своем ящике или         |                                       |                                                    |
	|                                 | отправить контрагенту.                              |                                       |                                                    |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Где хранится                    | в ящике отправителя или получателя                  | в ящике отправителя                   | в ящике отправителя                                |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Можно ли редактировать перед    | да, если указаны                                    | нет                                   | да, если указаны                                   |
	| отправкой                       | :ref:`настройки редактирования <editing_settings>`  |                                       | :ref:`настройки редактирования <editing_settings>` |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Что будет после отправки        | в зависимости от настроек:                          | черновик будет удален                 | будет отправлен контрагенту                        |
	|                                 |                                                     |                                       |                                                    |
	|                                 | - если шаблон одноразовый, то он будет удален       |                                       |                                                    |
	|                                 |   после создания документа;                         |                                       |                                                    |
	|                                 | - если шаблон многоразовый, то он продолжит         |                                       |                                                    |
	|                                 |   существовать после создания документа.            |                                       |                                                    |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+

Дополнение сообщения
--------------------

Сформированные сообщения можно дополнять :doc:`служебными документами <docservice>` и титулами последующих участников с помощью метода :doc:`../http/PostMessagePatch`, в который передается структура :doc:`../proto/MessagePatchToPost`. Эта структура должна содержать идентификатор :doc:`ящика <../entities/box>`, хранящего сообщение, и идентификатор цепочки документооборота, которую нужно дополнить новым документом.
Пользователь, вызывающий метод, должен иметь доступ к ящику, в котором хранится сообщение.

Пример заполнения структуры :doc:`../proto/MessagePatchToPost`:

.. container:: toggle

 .. code-block:: json

   "BoxId": "db32772b-9256-49a8-a133-fda593fda38a",
   "MessageId": "bbcedb0d-ce34-4e0d-b321-3f600c920935",
   "RecipientTitles": [
         {
            "ParentEntityId":"30cf2c07-7297-4d48-bc6f-ca7a80e2cf95&",
            "SignedContent":
            {
               "Content": "PD94bWwgdmVyc2l...LDQudC7Pg==",      // содержимое XML-файла в кодировке base-64
               "Signature": "MIIN5QYJKoZIhvc...KsTM6zixgz"      // содержимое файла подписи в кодировке base-64
            }
         }
      ]
   }

В результате работы метода сообщение будет обновлено в ящиках всех участников документооборота. В ящике получателя обновление может произойти с задержкой.