Отправка документов
===================

.. contents:: :local:
	:depth: 3

Работать с документами можно только внутри :doc:`сообщения <../entities/message>`.


.. _doc_prepare_to_sign:

Подготовка документа к подписанию
---------------------------------

Метод :doc:`../http/PrepareDocumentsToSign` позволяет автоматически добавить в XML-файл информацию о подписанте. К подписанию можно подготовить :doc:`черновик<../entities/draft>`, незагруженный в Диадок формализованный документ или :ref:`неотправленный исходящий документ<doc_delaysend>`. Дополнить можно только первый титул документа, второй титул генерируется сразу со всеми данными. 

Кроме данных подписанта в файл можно добавить:

	- версию формата и программы,
	- дату и время формирования файлов,
	- идентификатор файла.

Данные подписанта, в зависимости от его типа, можно указать в структурах :doc:`../proto/Signer` или :doc:`../proto/ExtendedSigner` или в поле ``SignerContent``. Чтобы определить тип подписанта, используйте метод :doc:`../http/GetDocumentTypes`, тип подписанта вернется в поле ``SignerType`` структуры :ref:`signer-info2`.

В зависимости от типа подписанта заполните его следующим образом:

	- простой подписант — при вызове метода ``PrepareDocumentsToSign`` заполните структуру ``Signer``.
	- расширенный подписант — при вызове метода ``PrepareDocumentsToSign`` заполните структуру ``ExtendedSigner``.
	- универсальный подписант — передайте бинарное представление упрощенного XML-файла подписанта в поле ``SignerContent``. Чтобы подготовить упрощенный XML-файл подписанта, выполните следующие действия: 

		#. Получите файл XSD-схемы упрощенного XML подписанта с помощью метода :doc:`../http/GetDocumentTypes`. Инструкция о получении данных для подписанта из метода ``GetDocumentTypes`` приведена в разделе :ref:`doctype_signer`.
		#. По полученной схеме подготовьте упрощенный XML-файл подписанта одним из следующих способов:

			- Используйте кодогенерацию в SDK. В C# SDK для всех версий формата 970 есть `пример кодогенерации <https://github.com/diadoc/diadocsdk-csharp/tree/master/src/DataXml/Utd970/V050201>`_ для подписанта. Кодогенерация осуществляется `инструментом xsd.exe <https://docs.microsoft.com/ru-ru/dotnet/standard/serialization/xml-schema-definition-tool-xsd-exe>`_. Чтобы воспользоваться ей в C#-клиенте, нужно заполнить объект ``Signer`` и `сериализовать его в XML <https://github.com/diadoc/diadocsdk-csharp/blob/master/src/XmlSerializerExtensions.cs>`_.
			- Укажите все данные для блока Подписант вручную в упрощенном XML-файле.
			- Укажите в файле данные, по которым Диадок сможет дополнить информацию, например, идентификатор ящика организации, отпечаток сертификата, регистрационный номер МЧД и ИНН доверителя. Диадок по переданным данным заполнит блок Подписант.

В ответе метод ``PrepareDocumentsToSign`` возвращает список документов, подготовленных к подписанию и отправке.

Пример сформированного в соответствии с :download:`XSD-схемой <../xsd/UniversalSignerForPatch.xsd>` подписанта для УПД 970 формата:

::

    <?xml version="1.0" encoding="Windows-1251"?>
    <Signers>
        <Signer SignatureType="1" SignerPowersConfirmationMethod="3" SigningDate="21.01.2024">
            <Certificate CertificateThumbprint="0e097989b91332008c052b5da5a7dd6424e6c2ac"/>
            <Fio FirstName="Петр" LastName="Петров" MiddleName="Петрович"/>
            <Position PositionSource="Manual">Подписант-Должн</Position>
            <SignerAdditionalInfo SignerAdditionalInfoSource="Manual">Подписант-ДопСведПодп</SignerAdditionalInfo>
            <PowerOfAttorney>
            <Electronic>
                <Manual RegistrationNumber="4a743152-e772-4249-9a47-e2e290258e79" RegistrationDate="17.09.2018" InternalNumber="123" InternalDate="18.09.2018" SystemId="СвДоверЭл-ИдСистХран" SystemUrl="СвДоверЭл-УРЛСист"/>
            </Electronic>
            </PowerOfAttorney>
        </Signer>
    </Signers>

- ``SignerStatus`` — статус подписанта, может принимать значения:

	- 1 — лицо, имеющее полномочия на подписание документа без доверенности,
	- 2 — лицо, имеющее полномочия на подписание документа на основании доверенности в электронной форме,
	- 3 — лицо, имеющее полномочия на подписание документа на основании доверенности на бумажном носителе.

- ``SignatureType`` — тип подписи, может принимать значения:

	- 1 — усиленная квалифицированная электронная подпись,
	- 2 — простая электронная подпись,
	- 3 — усиленная неквалифицированная электронная подпись.

- ``SignerPowersConfirmationMethod`` — способ подтверждения полномочий представителя на подписание документа. Используется для документов формата №970. Может принимать значения:

	- 1 — в соответствии с данными, содержащимися в электронной подписи,
	- 2 — в соответствии с доверенностью в электронной форме в машиночитаемом виде, если представление доверенности осуществляется посредством включения в каждый пакет электронных документов, подписываемых представителем,
	- 3 — в соответствии с доверенностью в электронной форме в машиночитаемом виде, если представление доверенности осуществляется из информационной системы. При этом необходимая информация для запроса доверенности из информационной системы, указана в электронном документе,
	- 4 — в соответствии с доверенностью в электронной форме в машиночитаемом виде, если представление доверенности осуществляется из информационной системы. При этом необходимая информация для запроса доверенности из информационной системы, представляется способом, отличным от указания в электронном документе,
	- 5 — в соответствии с доверенностью в форме документа на бумажном носителе,
	- 6 — иное.

- ``SigningDate`` — дата подписания документа.
- ``Certificate`` — данные сертификата подписанта. Обязательное поле. Можно передать:

	- ``CertificateThumbprint`` — отпечаток сертификата,
	- ``CertificateBytes`` — сертификат, сериализованный в массив байтов в DER-кодировке.

- ``Position`` — должность подписанта.
- ``PositionSource`` — способ заполнения должности сотрудника:

	- ``Employee`` — заполнение из данных сотрудника в Диадоке,
	- ``Certificate`` — заполнение из данных в сертификате,
	- ``StorageByTitleTypeId`` — заполнение из данных, сохраненных с помощью метода :doc:`../http/ExtendedSignerDetailsV2` для указанного сертификата и ``documentTitleType``,
	- ``Manual`` — ручное заполнение данных.

- ``SignerAdditionalInfo`` — дополнительные сведения о подписанте.
- ``SignerAdditionalInfoSource`` — способ заполнения дополнительных сведений, может принимать значения:

	- ``StorageByTitleTypeId`` — заполнение из данных, сохраненных с помощью метода :doc:`../http/ExtendedSignerDetailsV2` для указанного сертификата и ``documentTitleType``,
	- ``Manual`` — ручное заполнение данных.

- ``PowerOfAttorney`` — сведения о машиночитаемой доверенности. Доверенность может быть электронной или бумажной.

	- ``Electronic`` — электронная доверенность. Данные доверенности можно заполнить автоматически или вручную.

		- ``MethodOfProviding`` — способ представления доверенности. Обязательное поле. Может принимать значения:

			- 1 — представление доверенности осуществляется посредством ее включения в пакет электронных документов,
			- 2 — представление доверенности способом, не предусматривающим его включение в пакет электронных документов.

		- ``Storage`` — автоматическое заполнение информации по доверенности на основе номера и ИНН:

			- ``RegistrationNumber`` — номер доверенности, обязательное поле,
			- ``IssuerInn`` — ИНН организации, выдавшей доверенность, обязательное поле,
			- ``UseDefault`` — флаг, указывающий, нужно ли автоматически заполнить информацию на основе доверенности, используемой сотрудником по умолчанию. Обязательное поле.

		- ``Manual`` — ручное заполнение данных доверенности. Можно указать следующие данные:

			- ``RegistrationNumber`` — номер доверенности,
			- ``RegistrationDate`` — дата совершения (выдачи) доверенности,
			- ``InternalNumber`` — внутренний регистрационный номер доверенности,
			- ``InternalDate`` — дата внутренней регистрации доверенности,
			- ``SystemId`` — идентифицирующая информация об информационной системе, в которой осуществляется хранение доверенности.

	- ``Paper`` — бумажная доверенность. Можно указать следующие данные:

		- ``Fio`` — фамилия, имя, отчество (при наличии) лица, подписавшего доверенность,
		- ``InternalNumber`` — внутренний регистрационный номер доверенности, обязательное поле,
		- ``RegistrationDate`` — дата совершения (выдачи) доверенности, обязательное поле,
		- ``IssuerInfo`` — сведения о доверителе.

.. _doc_send:

Отправка сообщения
------------------

Подписать и отправить исходящие сообщения можно с помощью метода :doc:`../http/PostMessage`.

Обратите внимание, что API Диадока не создает :doc:`файл подписи <../entities/signature>`, его нужно сгенерировать самостоятельно.

В теле запроса метода нужно передать структуру :doc:`../proto/MessageToPost`. Структура должна содержать идентификаторы ящиков участников документооборота и набор отправляемых документов:

	- ``FromBoxId`` — идентификатор :doc:`ящика <../entities/box>` отправителя. Можно указать только тот ящик, к которому у пользователя есть доступ с текущим авторизационным токеном.
	- ``ToBoxId`` — идентификатор :doc:`ящика <../entities/box>` получателя.
	- ``DocumentAttachment`` — вложенная структура для передачи XML-файла документа:

		- ``SignedContent.Content`` — XML-файл документа,
		- ``SignedContent.Signature`` — файл подписи,
		- ``TypeNamedId`` — тип документа,
		- ``Function`` — функция документа,
		- ``Version`` — версия документа,
		- ``SignedContent.PowerOfAttorneyToPost`` — машиночитаемая доверенность (МЧД). Указать ее можно следующими способами:

			- указать регистрационный номер МЧД в формате GUID и ИНН доверителя во вложенной структуре ``PowerOfAttorneyToPost.PowerOfAttorneyFullId`` в полях ``RegistrationNumber`` и ``IssuerInn`` соответственно,
			- использовать флаг ``PowerOfAttorneyToPost.UseDefault = true``, если у пользователя установлена МЧД по умолчанию;
			- передать файл доверенности и подпись к ней во вложенной структуре ``PowerOfAttorneyToPost.Contents``; файл передается в поле ``Content``, подпись — в поле ``Signature``.

**Пример тела запроса метода PostMessage:**

.. container:: toggle

 .. code-block:: json

	"FromBoxId": "db32772b-9256-49a8-a133-fda593fda38a",
	"ToBoxId": "13254c42-b4f7-4fd3-3324-0094aeb0f15a",
		"DocumentAttachments": [
		{
			"SignedContent":
			{
				"Content": "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0...NC50Ls+",		// содержимое XML-файла в кодировке base-64
				"Signature": "MIIN5QYJKoZIhvcNAQcCoIIN1jCCDdIA...kA9MJfsplqgW",		// содержимое файла подписи в кодировке base-64
				{
					"PowerOfAttorney":
					"FullId":
					{
						"RegistrationNumber": "регистрационный номер МЧД",
						"IssuerInn": "ИНН доверителя"
					},
				},
			},
			"TypeNamedId": "тип документа",
			"Function": "функция документа",
			"Version": "версия документа"
		}
	]

После вызова метода :doc:`../http/PostMessage` в ящике отправителя формируется:

	- цепочка документооборота и информация о связанных с ней документах,
	- событие о появлении сообщения.

В ящике получателя эта информация появится с некоторой задержкой: это связано с асинхронной передачей информации из ящика отправителя в ящик получателя. То есть успешный вызов метода :doc:`../http/PostMessage` гарантирует лишь появление исходящего сообщения в ящике отправителя.

Не отправляйте формализованные документы размером более 3 Мб. Это может увеличить время обработки документа и завершиться ошибкой.

Если размер отправляемого документа больше 500 Кб, рекомендуем использовать :doc:`полку документов <../entities/shelf>`.


.. _doc_delaysend:

Отложенная отправка
~~~~~~~~~~~~~~~~~~~

Когда нужно сохранить исходящий документ без отправки, чтобы подписать и отправить его позже, используйте **отложенную отправку**.
Это может быть полезно, если:

	- документы перед отправкой нужно согласовать с другими сотрудниками;
	- документ перед отправкой нужно дополнить данными, как в случае с :doc:`маркированными товарами <../howto/marking_ttgis>`;
	- когда документ был создан с помощью интеграционного решения, а подпись и отправка будет осуществляться из веб-сервиса.

Для отложенной отправки в структуре :doc:`../proto/MessageToPost` установите флаг ``DelaySend``. При вызове метода :doc:`../http/PostMessage` документ с этим флагом будет сохранен в разделе исходящих документов. Такой документ называется **исходящим неотправленным документом**.

Если вы планируете перед отправкой отредактировать документ, используйте :ref:`настройки редактирования <editing_settings>`. Для этого в поле ``MessageToPost.DocumentAttachment.EditingSettingId`` укажите значение идентификатора настройки редактирования, полученного у вашего менеджера.

Чтобы согласовать исходящий неотправленный документ, используйте метод :doc:`../http/PostMessagePatch`. Исходящий неотправленный документ можно подписать несколькими :ref:`согласующими подписями <resolution_signature>`.

Если никаких действий с документом больше не требуется, его можно подписать и отправить с помощью метода :doc:`../http/PostMessagePatch`. Подписание неотправленного документа :doc:`основной подписью <../entities/signature>` равносильно его отправке.

Исходящий неотправленный документ можно найти с помощью метода :doc:`../http/GetDocuments`. Для этого в запросе используйте фильтр ``DocumentStatus = WaitingForSenderSignature``.

У исходящего неотправленного документ есть ограничения:

- под таким документом не может быть подписи или запроса на подпись по доверенности,
- нельзя изменить содержимое документа и реквизиты получателя, за исключением документов с :ref:`настройками редактирования <editing_settings>`.

Отличия исходящего неотправленного документа от других сущностей приведено в :ref:`таблице <template_draft_delaysend>`.


.. _doc_draft:

Создание черновика
~~~~~~~~~~~~~~~~~~

Метод :doc:`../http/PostMessage` можно использовать для создания :doc:`черновиков <../entities/draft>` — сообщений, содержащих документы без подписей к ним.

Чтобы создать черновик, укажите флаг ``IsDraft`` в структуре :doc:`../proto/MessageToPost` при создании сообщения. Такое сообщение будет загружено на сервер, но задание на отправку сообщения получателю формироваться не будет.

Для формирования подписей к документам и отправки сообщения на основе черновика используйте метод :doc:`../http/SendDraft`.


.. _template_draft_delaysend:

Шаблон, черновик или неотправленный документ
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Используйте :doc:`шаблон <../entities/template>`, :doc:`черновик <../entities/draft>` или :ref:`исходящий неотправленный документ <doc_delaysend>` в подходящих для этого сценариях. Ниже в таблице приведены различия этих сущностей.

.. table:: Различия черновика, шаблона и исходящего неотправленного документа

	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	|                                 | Шаблон                                              | Черновик                              | Исходящий неотправленный документ                  |
	+=================================+=====================================================+=======================================+====================================================+
	| Свойства                        | Сообщение без подписей. На его основе можно создать | «Заготовка» документа, т.е. сущность, | Уже готовый к отправке документ, сохраненный в     |
	|                                 | один или несколько документов — в зависимости от    | на основе которой можно создать один  | разделе «Исходящие».                               |
	|                                 | настроек.                                           | документ.                             | Имеет статус «Требуется подписать и отправить».    |
	|                                 | С шаблоном можно работать в своем ящике или         |                                       |                                                    |
	|                                 | отправить контрагенту.                              |                                       |                                                    |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Где хранится                    | в ящике отправителя или получателя                  | в ящике отправителя                   | в ящике отправителя                                |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Можно ли редактировать перед    | да, если указаны                                    | нет                                   | да, если указаны                                   |
	| отправкой                       | :ref:`настройки редактирования <editing_settings>`  |                                       | :ref:`настройки редактирования <editing_settings>` |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+
	| Что будет после отправки        | в зависимости от настроек:                          | черновик будет удален                 | будет отправлен контрагенту                        |
	|                                 |                                                     |                                       |                                                    |
	|                                 | - если шаблон одноразовый, то он будет удален       |                                       |                                                    |
	|                                 |   после создания документа;                         |                                       |                                                    |
	|                                 | - если шаблон многоразовый, то он продолжит         |                                       |                                                    |
	|                                 |   существовать после создания документа.            |                                       |                                                    |
	+---------------------------------+-----------------------------------------------------+---------------------------------------+----------------------------------------------------+


.. _editing_settings:

Настройки редактирования
~~~~~~~~~~~~~~~~~~~~~~~~

Настройки редактирования дают возможность создать документ, который можно будет отредактировать перед отправкой.

Они «ослабляют» требования к документу и позволяют подготовить документ для отправки с незаполненными полями. Незаполнены могут быть даже обязательные поля формализованного документа, например, номер документа. Такой документ нужно дозаполнить перед отправкой. Кроме этого настройки редактирования позволяют создать документ с заполенными полями, которые можно отредактировать перед отправкой.

Не все поля документа можно сделать редактируемыми. Диадок позволяет создать редактируемые документы с типами и полями, описанными ниже в таблице.

Для каждого из перечисленных типа документа и его набора полей существует собственный уникальный идентификатор настройки редактирования ``EditingSettingId``. В таблице приведены XSD-схемы настроек редактирования, согласно которому нужно дозаполнить документ перед отправкой.

Указать настройки редактирования можно только для :doc:`шаблона <../entities/template>` или документа с :ref:`отложенной отправкой <doc_delaysend>`. Для этого используйте следующие методы:

	- :doc:`../http/PostTemplate` — для шаблона; чтобы заполнить настройки редактирования, следуйте :ref:`инструкции <template_editing>`.
	- :doc:`../http/PostMessage` с параметром ``DelaySend`` — для исходящего неотправленного документа; укажите идентификатор настройки редактирования в поле ``EditingSettingId`` структуры :doc:`../proto/DocumentAttachment`.

.. table:: Настройки редактирования

	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	| Тип документа                                       | Редактируемые поля                                                                                       | EditingSettingId                                                         | XSD-схема                                                                                                            |
	+=====================================================+==========================================================================================================+==========================================================================+======================================================================================================================+
	| УПД                                                 | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:**                                       | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_Number.partial.xsd>`                                      |
	|                                                     |                                                                                                          |                                                                          |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД ДОП:** 3826FEB0-5615-4541-88AB-5C277A13AFF5                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФ:** 0AB682D9-C46A-48F8-9D18-A039A15A45A1                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФДОП:** D32AA982-DA4A-4B04-93D2-A5627E4BDFDE                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:**                                       | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_NumberAndDate.partial.xsd>`                               |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД ДОП:** 3460C613-5A01-405E-B57B-BB41AFC3FA0C                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФ:** CFC10492-EB1E-48D7-9085-F637763F3A05                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФДОП:** C1247C43-C12D-4D91-A043-4CD2E7BC3FA9                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:**                                       | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberBankDetails.partial.xsd>`                                |
	|                                                     | - Упрощенные банковские реквизиты                                                                        |                                                                          |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД ДОП:** 28687163-D1B8-4B52-90D8-DE9B9A504259                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФ:** 20D7231E-A6D2-4515-9227-281EE25185D8                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФДОП:** 79D4FCEE-81E4-486E-B062-43A423A55E28                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:**                                       | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberDateBankDetails.partial.xsd>`                            |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Упрощенные банковские реквизиты                                                                        | - **УПД ДОП:** A8D4F047-EFA1-458C-B11F-56F31A6254B8                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФ:** 83F6E535-D513-4EAA-8131-7D983688183F                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФДОП:** 382C141F-2506-4027-B20E-6DAD090401A1                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:**                                       | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberDateExtendedBankDetails.partial.xsd>`                    |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Расширенные банковские реквизиты                                                                       | - **УПД ДОП:** D885C4AB-D87A-4650-820A-6221F0B76563                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФ:** AC18F2A1-45A2-44FD-8DE0-48F53B9AA51A                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФДОП:** EB3AE323-E0CF-4379-8D2F-A6C158C8BCC8                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:**                                       | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_NumberAndDocumentShipment.partial.xsd>`                   |
	|                                                     | - Строка 5А                                                                                              |                                                                          |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФ:** 02CB961D-6DAB-4D8A-A2D6-612BBB161C97                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФДОП:** 9C72B4A1-3E5A-47B8-A7B5-CAE6B7D81574                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:**                                       | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_NumberAndDateAndDocumentShipment.partial.xsd>`            |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Строка 5А                                                                                              | - **УПД СЧФ:** 62857323-EBBA-401C-BB63-AE7E7CDDAD9D                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФДОП:** 051F095F-6956-4B89-AA2C-A20C8C79CB28                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_01_02_hyphen:**                                          | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberBankDetailsAndDocumentShipment.partial.xsd>`             |
	|                                                     | - Упрощенные банковские реквизиты                                                                        |                                                                          |                                                                                                                      |
	|                                                     | - Строка 5А                                                                                              | - **УПД СЧФ:** 5A89BA2C-A27F-4181-B150-AA7D18D008B8                      |                                                                                                                      |
	|                                                     |                                                                                                          | - **УПД СЧФДОП:** 5804E420-229C-40CD-8873-B7AC46CA44AC                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_01_02_hyphen:**                                          | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberDateBankDetailsAndDocumentShipment.partial.xsd>`         |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Упрощенные банковские реквизиты                                                                        | - **УПД СЧФ:** 4A5526F3-474C-41B3-A6BB-0F352B85E00B                      |                                                                                                                      |
	|                                                     | - Строка 5А                                                                                              | - **УПД СЧФДОП:** E2CD2784-5E22-4A3C-ACAF-6D1648036009                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_01_02_hyphen:**                                          | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberDateExtendedBankDetailsAndDocumentShipment.partial.xsd>` |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Расширенные банковские реквизиты                                                                       | - **УПД СЧФ:** 60775A1A-512C-4CA3-8043-2B2ED7D606A5                      |                                                                                                                      |
	|                                                     | - Строка 5А                                                                                              | - **УПД СЧФДОП:** B0FBDA17-9E86-403D-B747-864334E22C89                   |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_01_02_hyphen:**                                          | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_NumberAndDateAndPaymentDocuments.partial.xsd>`            |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Платежно-расчетные документы                                                                           | - **УПД СЧФ:** 7A08EEA9-24EB-4B0C-966D-82341983D20E                      |                                                                                                                      |
	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	| Счет-фактура                                        | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 0AB682D9-C46A-48F8-9D18-A039A15A45A1  | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_Number.partial.xsd>`                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** CFC10492-EB1E-48D7-9085-F637763F3A05  | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_NumberAndDate.partial.xsd>`                               |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 20D7231E-A6D2-4515-9227-281EE25185D8  | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberBankDetails.partial.xsd>`                                |
	|                                                     | - Упрощенные банковские реквизиты                                                                        |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 83F6E535-D513-4EAA-8131-7D983688183F  | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberDateBankDetails.partial.xsd>`                            |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Упрощенные банковские реквизиты                                                                        |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** AC18F2A1-45A2-44FD-8DE0-48F53B9AA51A  | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberDateExtendedBankDetails.partial.xsd>`                    |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Расширенные банковские реквизиты                                                                       |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 02CB961D-6DAB-4D8A-A2D6-612BBB161C97  | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_NumberAndDocumentShipment.partial.xsd>`                   |
	|                                                     | - Строка 5А                                                                                              |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 62857323-EBBA-401C-BB63-AE7E7CDDAD9D  | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_NumberAndDateAndDocumentShipment.partial.xsd>`            |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Строка 5А                                                                                              |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 5A89BA2C-A27F-4181-B150-AA7D18D008B8  | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberBankDetailsAndDocumentShipment.partial.xsd>`             |
	|                                                     | - Упрощенные банковские реквизиты                                                                        |                                                                          |                                                                                                                      |
	|                                                     | - Строка 5А                                                                                              |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 4A5526F3-474C-41B3-A6BB-0F352B85E00B  | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberDateBankDetailsAndDocumentShipment.partial.xsd>`         |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Упрощенные банковские реквизиты                                                                        |                                                                          |                                                                                                                      |
	|                                                     | - Строка 5А                                                                                              |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 60775A1A-512C-4CA3-8043-2B2ED7D606A5  | :download:`скачать <../xsd/Partial/Utd820_SenderTitle_NumberDateExtendedBankDetailsAndDocumentShipment.partial.xsd>` |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Расширенные банковские реквизиты                                                                       |                                                                          |                                                                                                                      |
	|                                                     | - Строка 5А                                                                                              |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия utd820_05_01_02_hyphen:** 7A08EEA9-24EB-4B0C-966D-82341983D20E  | :download:`скачать <../xsd/Partial/Utd820V5010XSenderTitle_NumberAndDateAndPaymentDocuments.partial.xsd>`            |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Платежно-расчетные документы                                                                           |                                                                          |                                                                                                                      |
	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	| Акт                                                 | - Дата документа                                                                                         | **Версия utd820_05_01_02_hyphen:** D4A71C30-7AE7-438D-B61A-EE19F71BB2E9  | :download:`скачать <../xsd/Partial/XmlAcceptanceCertificate_Date.partial.xsd>`                                       |
	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	| Акт сверки                                          | - Остаток кредиторской задолженности перед контрагентом всего по договору отгрузки                       | **Версия aktsver_01_01:** 1816B70B-1D8B-455C-981D-A02F973838BA           | :download:`скачать <../xsd/Partial/BMW_OAKTSVER_01_01.partial.xsd>`                                                  |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом всего по ТС                                      |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по зап. частям                                   |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по ретро-скидкам                                 |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по демонстрационным ТС                           |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по прочей реализации                             |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по комплексу консультационных услуг              |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по доступу к программному обеспечению и эл.базам |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по процентам                                     |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по предоплате за ТС                              |                                                                          |                                                                                                                      |
	|                                                     | - Остаток кредиторской задолженности перед контрагентом по авансовым платежам                            |                                                                          |                                                                                                                      |
	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	| Счет                                                | - Номер документа                                                                                        | **Версия proformainvoice_01_01:** 04C66406-B3C4-4697-A4BA-305E254CA549   | :download:`скачать <../xsd/Partial/ProformaInvoice_NumberAndDate.partial.xsd>`                                       |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия proformainvoice_01_01:** D31B465A-6EA2-456B-82DD-C278F473EEE1   | :download:`скачать <../xsd/Partial/ProformaInvoice_NumberAndDateAndSum.partial.xsd>`                                 |
	|                                                     | - Дата документа                                                                                         |                                                                          |                                                                                                                      |
	|                                                     | - Сумма                                                                                                  |                                                                          |                                                                                                                      |
	|                                                     +----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	|                                                     | - Номер документа                                                                                        | **Версия proformainvoice_01_01:** 20496284-AD36-4AB3-A9BD-EF419F39D814   | :download:`скачать <../xsd/Partial/ProformaInvoice_NumberAndBank.partial.xsd>`                                       |
	|                                                     | - Упрощенные банковские реквизиты                                                                        |                                                                          |                                                                                                                      |
	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	| Показания электроэнергии                            | - Показания счетчика новое                                                                               | **Версия pokaz_01_01:** 87A9979D-EC83-41A1-BF4E-5CF066A9952E             | :download:`скачать <../xsd/Partial/POKAZ_01_01.partial.xsd>`                                                         |
	|                                                     | - Дополнительный расход электроэнергии                                                                   |                                                                          |                                                                                                                      |
	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	| Сведения о расходах воды                            | - Текущие показания                                                                                      | **Версия svedrashvod_01_01:** 6D37C651-D012-4C52-9999-091ED48EE80D       | :download:`скачать <../xsd/Partial/OSVEDRASHVOD_01_01.partial.xsd>`                                                  |
	|                                                     | - Тип расчета                                                                                            |                                                                          |                                                                                                                      |
	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+
	| Заявка на оказание транспортно-экспедиционных услуг | - Данные о водителе                                                                                      | **Версия trnsrdr_01_01:** 0E1B451E-01C7-461A-82E9-0DCA359329CB           | :download:`скачать <../xsd/Partial/TRANS_RESPONSE.partial.xsd>`                                                      |
	|                                                     | - Данные о транспортном средстве                                                                         |                                                                          |                                                                                                                      |
	+-----------------------------------------------------+----------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------+


.. _doc_patch:

Дополнение сообщения
--------------------

Сформированные сообщения можно дополнять :doc:`служебными документами <docservice>` и титулами последующих участников с помощью метода :doc:`../http/PostMessagePatch`.

Эта структура должна содержать идентификатор :doc:`ящика <../entities/box>`, хранящего сообщение, и идентификатор цепочки документооборота, которую нужно дополнить новым документом.
Пользователь, вызывающий метод, должен иметь доступ к ящику, в котором хранится сообщение.

В теле запроса метода передайте структуру :doc:`../proto/MessagePatchToPost`, заполненную следующими данными:

	- ``BoxId`` — идентификатор :doc:`ящика <../entities/box>`, в котором находится исходное сообщение.
	- ``MessageId`` — идентификатор сообщения, к которому относится дополнение.
	- ``RecipientTitles`` — вложенная структура для передачи XML-файла титула:

		- ``ParentEntityId`` — идентификатор титула продавца,
		- ``SignedContent.Content`` — XML-файл документа,
		- ``SignedContent.Signature`` — файл подписи.

Обратите внимание, что API Диадока не создает :doc:`файл подписи <../entities/signature>`, его нужно сгенерировать самостоятельно.

**Пример HTTP-запроса метода PostMessagePatch:**

.. code-block:: http

	POST /V3/PostMessagePatch HTTP/1.1
	Host: diadoc-api.kontur.ru
	Authorization: DiadocAuth ddauth_api_client_id={{ключ разработчика}}, ddauth_token={{авторизационный токен}}
	Content-Type: application/json; charset=utf-8

**Пример тела запроса метода PostMessagePatch:**

.. container:: toggle

 .. code-block:: json

	"BoxId": "db32772b-9256-49a8-a133-fda593fda38a",
	"MessageId": "bbcedb0d-ce34-4e0d-b321-3f600c920935",
	"RecipientTitles": [
		{
			"ParentEntityId":"30cf2c07-7297-4d48-bc6f-ca7a80e2cf95&",
			"SignedContent":
			{
				"Content": "PD94bWwgdmVyc2l...LDQudC7Pg==",      // содержимое XML-файла в кодировке base-64
				"Signature": "MIIN5QYJKoZIhvc...KsTM6zixgz"      // содержимое файла подписи в кодировке base-64
			}
		}
	]

После отправки в теле ответа метода вернется отправленное дополнение, представленное структурой :doc:`../proto/MessagePatch`.

В результате работы метода сообщение будет обновлено в ящиках всех участников документооборота. В ящике получателя обновление может произойти с задержкой.