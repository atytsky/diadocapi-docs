Документооборот актов
=====================

Форматы
-------

.. note:: Подробнее про электронные акты можно прочитать на `сайте Диадока <https://www.diadoc.ru/docs/forms/first-documents/Act>`__.

Формат акта утвержден приказом `N ММВ-7-10/552@ <https://normativ.kontur.ru/document?moduleId=1&documentId=339635>`_. XSD-схемы для генерации титулов электронного акта:

	- :download:`XSD-схема титула исполнителя <../xsd/DP_REZRUISP_1_990_01_05_01_02.xsd>`,
	- :download:`XSD-схема титула заказчика <../xsd/DP_REZRUZAK_1_990_02_05_01_02.xsd>`.

Универсальный передаточный документ можно использовать как первичный документ, подтверждающий совершение хозяйственной операции. Формат УПД утвержден следующими приказами:

	- `№ ММВ-7-15/820@ <https://normativ.kontur.ru/document?moduleId=1&documentId=328588>`__ (действует до 01.04.2025),
	- `№ ЕД-7-26/970@ <https://normativ.kontur.ru/document?moduleId=1&documentId=464695>`__.

XSD-схемы для генерации титула исполнителя электронного акта:

	- :download:`XSD-схема титула продавца УПД (функция ДОП) 820 формата <../xsd/ON_NSCHFDOPPR_1_997_01_05_01_01.xsd>`,
	- :download:`XSD-схема титула продавца УПД (функция ДОП) 970 формата <../xsd/ON_NSCHFDOPPR_1_997_01_05_02_01.xsd>`.

XSD-схемы для генерации титула заказчика электронного акта:

	- :download:`XSD-схема титула покупателя УПД (функция ДОП) 820 формата <../xsd/ON_NSCHFDOPPOK_1_997_02_05_01_01.xsd>`,
	- :download:`XSD-схема титула продавца УПД (функция ДОП) 970 формата <../xsd/ON_NSCHFDOPPOK_1_997_02_05_02_01.xsd>`.

XSD-схемы первого и второго титулов акта последней версии форматов можно получить с помощью метода :doc:`../http/GetDocumentTypes`. Метод вернет ссылку на скачивание схемы в поле ``XsdUrl`` структуры :doc:`DocumentTitle <../proto/DocumentTypeDescription>`.

.. table:: Соответствие формата и версии документа

	+--------------------------+-----------------------+--------------+------------------------+
	| Тип документа            | Формат                | Функция      | Version                |
	+==========================+=======================+==============+========================+
	| XmlAcceptanceCertificate | приказ №970           | ДОП          | utd970_05_02_01        |
	+--------------------------+-----------------------+--------------+------------------------+
	| XmlAcceptanceCertificate | приказ №820           | ДОП          | utd820_05_01_02_hyphen |
	+--------------------------+-----------------------+--------------+------------------------+
	| XmlAcceptanceCertificate | приказ №155 (устарел) | ДОП          | utd_05_02_01           |
	+--------------------------+-----------------------+--------------+------------------------+
	| XmlAcceptanceCertificate | приказ №552           |              | rezru_05_02_01         |
	+--------------------------+-----------------------+--------------+------------------------+
	| XmlAcceptanceCertificate | приказ №172 (устарел) |              | act_05_01_01           |
	|                          |                       |              | act_05_01_02           |
	+--------------------------+-----------------------+--------------+------------------------+

Генерация и парсинг
-------------------

Сгенерировать титулы исполнителя и заказчика можно с помощью метода :doc:`../http/GenerateTitleXml`. Распарсить документ можно с помощью метода :doc:`../http/ParseTitleXml`.

Версия документа ``documentVersion``, передаваемая в запросе, зависит от формата.

.. table:: Соответствие формата актов и версии документа

	+-------------+----------------------------------------------+
	| Формат      | DocumentVersion                              |
	+=============+==============================================+
	| Приказ №970 | ``documentVersion = utd970_05_02_01``        |
	+-------------+----------------------------------------------+
	| Приказ №820 | ``documentVersion = utd820_05_01_02_hyphen`` |
	+-------------+----------------------------------------------+
	| Приказ №552 | ``documentVersion = rezru_05_01_02``         |
	+-------------+----------------------------------------------+

Подписант
---------

Форматы УПД и УКД подразумевают расширенный набор полей для подписантов. Эти поля не содержатся в сертификате или в данных организации.

Если необходимых для подписания данных в Диадоке нет, то будет возникать ошибка.

Расширенные данные можно заполнить с помощью метода :doc:`../http/utd/ExtendedSignerDetailsV2`.

Добавить в XML-файл информацию о подписанте можно с помощью метода :doc:`../http/PrepareDocumentsToSign`. Подробная информация о типах и данных подписантов описана в разделе :ref:`doc_prepare_to_sign`.

Порядок обмена
--------------

.. note:: Порядок обмена электронными актами между компаниями через Диадок описан в `инструкции <https://wiki.diadoc.ru/pages/viewpage.action?pageId=1147084>`__.


Порядок обмена электронными актами соответствует порядку обмена двухтитульного электронного документа.

Для документов, возникающих в ходе документооборота электронных актов, в Диадоке зарезервированы :doc:`тип сущности <../proto/Entity message>` ``EntityType = Attachment`` и следующие типы вложения ``AttachmentType``:

	- ``XmlAcceptanceCertificate`` — для титула исполнителя электронного акта,
	- ``XmlAcceptanceCertificateBuyerTitle`` — для титула покупателя электронного акта.

Приведенная ниже схема демонстрирует порядок обмена электронными актами, реализованный в Диадоке:

#. Исполнитель формирует титул исполнителя акта *XmlAcceptanceCertificate*\ :sub:`1`\,  подписывает его и направляет Заказчику.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2`\  о дате получения титула акта, подписывает его и направляет Исполнителю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`2'`\  о дате отправки титула, подписывает его и направляет вместе с титулом исполнителя акта Заказчику.

#. Заказчик получает титул исполнителя акта *XmlAcceptanceCertificate*\ :sub:`3`\  и при необходимости отправляет в ответ подписанное извещение о получении *Receipt* \ :sub:`4`\.

#. Заказчик формирует в ответ титул заказчика акта *XmlAcceptanceCertificateBuyerTitle*\ :sub:`5`\,  подписывает его и отправляет в сторону Исполнителя.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6`\  о дате получения титула заказчика акта, подписывает его и направляет Заказчику.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`6'`\  о дате отправки титула заказчика акта, подписывает его и направляет вместе Исполнителю.

#. Исполнитель получает титул заказчика акта и при необходимости отправляет в ответ подписанное извещение о получении *Receipt*\ :sub:`8`\.

#. Если Заказчик обнаружил ошибки в полученном титуле исполнителя акта, он формирует отказ в подписи *XmlSignatureRejection*\ :sub:`9`\,  подписывает его и направляет Исполнителю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`10`\  о дате получения отказа в подписи подписывает его и направляет Исполнителю.

#. Диадок формирует подтверждение оператора *InvoiceConfirmation*\ :sub:`10'`\  о дате отправки отказа в подписи подписывает его и направляет вместе с отказом в подписи *XmlSignatureRejection*\ :sub:`11`\  Заказчику.


.. image:: ../_static/img/docflows/scheme-04-akt-docflow.png
	:align: center

Старый порядок обмена
---------------------

.. raw:: html

   <details>
   <summary><a>Подробнее</a></summary>

Схема, приведенная ниже, демонстрирует порядок обмена электронными актами, реализованный в Диадоке:

#.  Исполнитель формирует титул исполнителя акта *XmlAcceptanceCertificate*\ :sub:`1`\, подписывает его и направляет Заказчику.

#.  Диадок доставляет титул исполнителя акта *XmlAcceptanceCertificate*\ :sub:`2`\ до Заказчика.

#.  Заказчик получает титул исполнителя акта *XmlAcceptanceCertificate*\ :sub:`2`\, и формирует в ответ титул заказчика акта *XmlAcceptanceCertificateBuyerTitle*\ :sub:`3`\, подписывает его и отправляет в сторону Исполнителя.

#.  Диадок доставляет титул заказчика акта *XmlAcceptanceCertificateBuyerTitle*\ :sub:`4`\ до Исполнителя.

#.  Если Заказчик обнаружил ошибки в полученном титуле исполнителя акта, он формирует отказ в подписи *XmlSignatureRejection*\ :sub:`5`\, подписывает его и направляет Исполнителя.

#.  Диадок доставляет отказ в подписи *XmlSignatureRejection*\ :sub:`5`\ до Исполнителя.


.. image:: ../_static/img/docflows/scheme-03-akt-docflow.png
	:align: center

.. raw:: html

   </details>
   