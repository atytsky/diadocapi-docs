Генерация и парсинг
===================

.. contents:: :local:

Генерация формализованного документа
------------------------------------

Через Диадок можно :ref:`отправить <doc_send>` как формализованные, так и неформализованные документы. Неформализованные документы могут быть представлены в любом формате. Формализованные документы должны представлять собой XML-файлы в формате, рекомендованном ФНС.

Вы можете сформировать формализованный документ самостоятельно или с помощью метода :doc:`../http/GenerateTitleXml`. Для этого в метод ``GenerateTitleXml`` нужно передать следующие параметры:

- ``documentTypeNamedId`` — тип документа;
- ``documentFunction`` — функция документа;
- ``documentVersion`` — версия документа;
- ``titleIndex`` — идентификатор титула документа.

В теле запроса нужно передать XML-файл ``UserDataXsd``, соответствующий XSD-схеме. ``UsedDataXsd`` содержит информацию для генерации титула, которую может заполнить только пользователь.

Получить тип, функцию, версию, идентификатор титула и ссылку на скачивание XSD-схемы можно с помощью метода :doc:`../http/GetDocumentTypes`. В ответе метод возвращает описание всех типов документов, доступных в ящике.

Метод ``GenerateTitleXml`` в ответе вернет сгенерированный в соотвтетсвии с XSD-схемой XML-файл титула.

Подготовка документа к подписанию
---------------------------------

Метод :doc:`../http/PrepareDocumentsToSign` позволяет автоматически добавить в XML-файл информацию о подписанте. К подписанию можно подготовить :doc:`черновик<../entities/draft>`, незагруженный в Диадок формализованный документ или :ref:`неотправленный исходящий документ<doc_delaysend>`. Дополнить можно только первый титул документа, второй титул генерируется сразу со всеми данными. 

Кроме данных подписанта Диадок может добавить в файл:

	- версию формата и программы,
	- дату и время формирования файлов,
	- идентификатор файла.

Данные подписанта, в зависимости от его типа, можно указать в структурах :doc:`../proto/Signer` или :doc:`../proto/utd/ExtendedSigner` или в поле ``SignerContent``. Чтобы определить тип подписанта, используйте метод :doc:`../http/GetDocumentTypes`, тип подписанта вернется в поле ``SignerType`` структуры :doc:`SignerInfoV2 <../proto/DocumentTypeDescriptionV2>`.

В зависимости от типа подписанта заполните его следующим образом:

	- простой подписант — при вызове метода ``PrepareDocumentsToSign`` заполните структуру ``Signer``.
	- расширенный подписант — при вызове метода ``PrepareDocumentsToSign`` заполните структуру ``ExtendedSigner``.
	- универсальный подписант — передайте бинарное представление упрощенного XML-файла подписанта в поле ``SignerContent``. Чтобы подготовить упрощенный XML-файл подписанта, нужно: 

		1. С помощью метода ``GetDocumentTypes`` получить URL-путь метода, возвращающего файл XSD-схемы упрощенного XML подписанта. URL-путь возвращается в поле ``SignerUserDataXsdUrl``.
		2. С помощью URL-пути вызвать метод :doc:`../http/GetContent`. В ответ метод вернет файл XSD-схемы SignerUserData.xsd.
		3. По полученной схеме подготовить упрощенный XML-файл подписанта одним из способов:
		
			- использовать кодогенерацию в SDK;
			- вручную указать все данные для блока Подписант в упрощенном XML-файле;
			- указать в файле данные, по которым Диадок сможет дополнить информацию, например, идентификатор ящика организации, отпечаток сертификата, регистрационный номер МЧД и ИНН доверителя. Диадок по переданным данным заполнит блок Подписант.

В ответе метод ``PrepareDocumentsToSign`` возвращает список документов, подготовленных к подписанию и отправке.

Парсинг документа
-----------------

Метод парсинга позволяет получить из XML-файла документа упрощенный XML ``UserDataXml``. Парсинг документа можно использовать, например, чтобы получить данные из предыдущих титулов для генерации титулов последующих участников или чтобы загрузить данные из него в свою учетную систему. Распарсить документ можно с помощью метода :doc:`../http/ParseTitleXml`.

Для парсинга нужны тип, функция, версия и идентификатор титула. Их можно узнать из ответов методов:

- :doc:`../http/GetNewEvents`,
- :doc:`../http/GetMessage`,
- :doc:`../http/GetDocument`,
- :doc:`../http/GetDocflowEvents_V3`,
- :doc:`../http/GetDocflows_V3`.

Также информацию можно получить по XML-файлу титула с помощью метода :doc:`../http/DetectDocumentTitles`: для этого в теле запроса метода передайте бинарное содержимое документа.