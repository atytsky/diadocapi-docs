Другие функции
==============

.. contents:: :local:

Отправка заявления участника ЭДО
--------------------------------

Отправить заявление участника электронного документооборота можно с помощью метода :doc:`http/SendFnsRegistrationMessage`.

Подготовка печатных форм
------------------------

Документы, которые передаются через Диадок в формализованном виде, выглядят как XML-файл и имеют нечитаемый вид.
Диадок позволяет получить печатную форму для таких документов, чтобы отобразить их пользователю в удобном формате.

В первую очередь эта функциональность предназначена для формирования печатных форм счетов-фактур, универсальных передаточных документов, накладных и актов о выполненных работах, предусмотренных порядком Минфина.

Печатные формы документов можно получить с помощью метода :doc:`http/GeneratePrintForm`.

Патчинг
-------

**Патчинг** — это автоматическое заполнение элементов или атрибутов документа на основании формата и информации в Диадоке. Пропатчить можно :doc:`черновик<entities/draft>`, незагруженный в Диадок документ или :ref:`неотправленный исходящий документ<doc_delaysend>`. Патчится только первый титул документа, второй титул генерируется сразу со всеми данными.

Диадок может добавить следующую информацию в файл:

	- версию формата и программы,
	- дату и время формирования файлов,
	- идентификатор файла,
	- данные подписанта.

Чтобы пропатчить документ, вызовите метод :doc:`../http/PrepareDocumentsToSign`, в ответе метод вернет список документов, подготовленных к подписанию и отправке.

Данные подписанта нужно передать при вызове метода :doc:`../http/PrepareDocumentsToSign` в структуре :doc:`../proto/Signer` или :doc:`../proto/utd/ExtendedSigner` или в поле ``SignerContent`` в зависимости от типа подписанта. Чтобы его определить, вызовите метод :doc:`../http/GetDocumentTypes`, тип подписанта вернется в поле ``SignerType`` структуры :doc:`SignerInfoV2 <../proto/DocumentTypeDescriptionV2>`.

Метод :doc:`../http/GetDocumentTypes` может вернуть три типа подписанта:

	- 1 — простой подписант. Используется для документов форматов :doc:`@93/@172 <../docflows/AttachmentVersion>` и своих типов документов не на базе форматов :doc:`@155/@820 <../docflows/AttachmentVersion>`. В этом случае при вызове метода :doc:`../http/PrepareDocumentsToSign` заполните структуру :doc:`../proto/Signer`.
	- 2 — расширенный подписант. Используется для документов форматов :doc:`@155/@189/@551/@552/@736/@820 <../docflows/AttachmentVersion>` и своих типов на базе форматов :doc:`@155/@820 <../docflows/AttachmentVersion>`. В этом случае при вызове метода :doc:`../http/PrepareDocumentsToSign` заполните структуру :doc:`../proto/utd/ExtendedSigner`.
	- 3 — универсальный подписант. В этом случае нужно передать бинарное представление упрощенного XML-файла подписанта в поле ``SignerContent``. Чтобы подготовить упрощенный XML-файл подписанта, нужно: 

		1. С помощью метода :doc:`../http/GetDocumentTypes` получить URL-путь метода, возвращающего файл XSD-схемы упрощённого XML подписанта. URL-путь возвращается в поле ``SignerUserDataXsdUrl``.
		2. С помощью URL-пути вызвать метод :doc:`../http/GetContent`. В ответ метод вернет файл XSD-схемы SignerUserData.xsd.
		3. По полученной схеме подготовить упрощенный XML-файл подписанта. Это можно сделать тремя способами:
		
			- использовать кодогенерацию в SDK;
			- вручную указать все данные для блока Подписант в упрощенном xml-файле;
			- указать в файле данные, по которым Диадок сможет дополнить информацию, например, идентификатор ящика организации, отпечаток сертификата, регистрационный номер МЧД и ИНН доверителя. Диадок по переданным данным заполнит блок Подписант.

.. _autoregistration:

Авторегистрация
---------------

**Авторегистрация** — это автоматическое создание в Диадоке сотрудника организации с правами администратора. Сотрудник будет создан, если пользователь имеет сертификат КЭП организации.

Сотрудник с правами администратора будет автоматически создан в организации, если выполняется хотя бы одно из условий:

	- В организации нет администраторов с подтвержденной учетной записью и действующим сертификатом.
	- В организации есть администратор с таким же СНИЛС, как в сертификате.
	- В сертификате указана одна из должностей: главный бухгалтер, генеральный директор, директор, главный врач, ректор.

Сотрудник не будет автоматически создан в организации, если:

	- Запрос пользователя на доступ в ящик раньше отклоняли.
	- Пользователя удаляли из организации.
	- Организация является частью филиальной структуры.
	- Сертификат выдан представительству/филиалу иностранной организации — ИНН начинается с “99”.
	- Сертификат выдан физическому лицу.

Зарегистрировать сотрудника можно с помощью следующих методов:

	- :doc:`../http/GetMyOrganizations`,
	- :doc:`../http/Register`,
	- любой метод, в котором есть идентификатор ящика ``boxId``. Если условия для авторегистрации не выполняются, метод вернет ошибку ``403 (Forbidden)``. Если в организации есть действующий администратор, то при вызове метода будет отправлен запрос на доступ к ящику. В этом случае метод вернет ошибку ``403 (Forbidden)`` с текстом ``Access to Box is denied. Request to admins of Box was created. Please try again later``.


.. _editing_settings:

Настройки редактирования
------------------------

Настройки редактирования дают возможность отправить документ, который можно будет отредактировать перед отправкой. 

Настройки редактирования «ослабляют» требования к документу и позволяют отправить документ с незаполненными полями. Незаполнены могут быть даже обязательные поля формализованного документа, например, номер документа. Такой документ нужно будет дозаполнить перед отправкой. Кроме этого настройки редактирования позволяют отправить документ с заполенными полями, которые можно будет отредактировать перед отправкой.

Не все поля документа в документе можно сделать редактируемыми. Диадок позволяет сделать редактируемые документы со следующими типами и полями:

.. table:: Настройки редактирования

	+---------------------------------+-------------------------------------------------------------------------+
	| Тип документа                   | Редактируемые поля                                                      |
	+=================================+=========================================================================+
	| УПД                             | - Номер документа                                                       |
	|                                 | - Номер + дата документа                                                |
	|                                 | - Номер документа + упрощенные банковские реквизиты                     |
	|                                 | - Номер + дата документа + упрощенные банковские реквизиты              |
	|                                 | - Номер + дата документа + расширенные банковские реквизиты             |
	|                                 | - Номер документа + строка 5А                                           |
	|                                 | - Номер + дата документа + строка 5А                                    |
	|                                 | - Номер документа + упрощенные банковские реквизиты + строка 5А         |
	|                                 | - Номер + дата документа + упрощенные банковские реквизиты + строка 5А  |
	|                                 | - Номер + дата документа + расширенные банковские реквизиты + строка 5А |
	|                                 | - Маркировка                                                            |
	+---------------------------------+-------------------------------------------------------------------------+
	| Приложение к УПД                | - Номер документа                                                       |
	+---------------------------------+-------------------------------------------------------------------------+
	| Показания электроэнергии        | - Показания счетчика новое                                              |
	|                                 | - Дополнительный расход электроэнергии                                  |
	+---------------------------------+-------------------------------------------------------------------------+
	| Поручение экспедитору           | - Данные о водителе                                                     |
	|                                 | - Данные о транспортном средстве                                        |
	+---------------------------------+-------------------------------------------------------------------------+
	| Заявка на перевозку             | - Данные о водителе                                                     |
	|                                 | - Данные о транспортном средстве                                        |
	+---------------------------------+-------------------------------------------------------------------------+
	| Заявка на оказание транспортно- | - Данные о водителе                                                     |
	| экспедиционных услуг            | - Данные о транспортном средстве                                        |
	+---------------------------------+-------------------------------------------------------------------------+

	
Для каждого из перечисленных в таблице типа документа и его набора полей существует собственный уникальный идентификатор настройки редактирования. Чтобы получить идентификатор настройки редактирования для конкретного набора полей документа, обратитесь к вашему менеджеру или в `техническую поддержку <https://www.diadoc.ru/support>`__.

Указать настройки редактирования можно только для :doc:`шаблона <entities/template>` или документа с :ref:`отложенной отправкой <doc_delaysend>`. Для этого используйте следующие методы:

	- :doc:`http/PostTemplate` — для :ref:`шаблона <template_editing>`; укажите идентификатор настройки редактирования в поле ``EditingSettingId`` структуры :doc:`proto/TemplateDocumentAttachment`,
	- :doc:`http/PostMessage` с параметром ``DelaySend`` — для исходящего неотправленного документа; укажите идентификатор настройки редактирования в поле ``EditingSettingId`` структуры :doc:`proto/DocumentAttachment`.